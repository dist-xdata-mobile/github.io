<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jar 包那些事 2 | Fellow Travellers</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <meta name="description" content="Fellow-Travellers documents for tech3D / mobile / calc / back-end">
    <link rel="preload" href="/assets/css/0.styles.d4a3a82a.css" as="style"><link rel="preload" href="/assets/js/app.16cdc938.js" as="script"><link rel="preload" href="/assets/js/3.4f14b16d.js" as="script"><link rel="preload" href="/assets/js/1.02cf7ae9.js" as="script"><link rel="preload" href="/assets/js/37.00738964.js" as="script"><link rel="prefetch" href="/assets/js/10.f5269c4e.js"><link rel="prefetch" href="/assets/js/100.c7e247ff.js"><link rel="prefetch" href="/assets/js/101.b60225bc.js"><link rel="prefetch" href="/assets/js/102.adacab9e.js"><link rel="prefetch" href="/assets/js/103.32cd0f3b.js"><link rel="prefetch" href="/assets/js/104.1fd9ea1d.js"><link rel="prefetch" href="/assets/js/105.5bfce959.js"><link rel="prefetch" href="/assets/js/106.44ca9c1d.js"><link rel="prefetch" href="/assets/js/107.9ee3fdbe.js"><link rel="prefetch" href="/assets/js/108.2e6ba386.js"><link rel="prefetch" href="/assets/js/109.12b4497c.js"><link rel="prefetch" href="/assets/js/11.9161989f.js"><link rel="prefetch" href="/assets/js/110.d255fdda.js"><link rel="prefetch" href="/assets/js/111.64c62930.js"><link rel="prefetch" href="/assets/js/112.6a427f04.js"><link rel="prefetch" href="/assets/js/113.5ec41ed5.js"><link rel="prefetch" href="/assets/js/114.d289af71.js"><link rel="prefetch" href="/assets/js/115.b052778b.js"><link rel="prefetch" href="/assets/js/116.f20d5acd.js"><link rel="prefetch" href="/assets/js/117.759b608c.js"><link rel="prefetch" href="/assets/js/118.a00460b4.js"><link rel="prefetch" href="/assets/js/119.021cbb12.js"><link rel="prefetch" href="/assets/js/12.e1aacb47.js"><link rel="prefetch" href="/assets/js/120.5bd8b71f.js"><link rel="prefetch" href="/assets/js/121.3e722ff2.js"><link rel="prefetch" href="/assets/js/122.a825e6c4.js"><link rel="prefetch" href="/assets/js/123.ff402ce6.js"><link rel="prefetch" href="/assets/js/124.287761b7.js"><link rel="prefetch" href="/assets/js/125.b4048370.js"><link rel="prefetch" href="/assets/js/126.bef086fd.js"><link rel="prefetch" href="/assets/js/127.a0784eab.js"><link rel="prefetch" href="/assets/js/128.66f3cbc1.js"><link rel="prefetch" href="/assets/js/129.aef33c57.js"><link rel="prefetch" href="/assets/js/13.faee7a70.js"><link rel="prefetch" href="/assets/js/130.0fbb1019.js"><link rel="prefetch" href="/assets/js/131.61f2146b.js"><link rel="prefetch" href="/assets/js/132.3d912bd8.js"><link rel="prefetch" href="/assets/js/133.b688ed34.js"><link rel="prefetch" href="/assets/js/134.59d26e48.js"><link rel="prefetch" href="/assets/js/135.2d1de6ca.js"><link rel="prefetch" href="/assets/js/136.82c509c1.js"><link rel="prefetch" href="/assets/js/137.aa6f5b18.js"><link rel="prefetch" href="/assets/js/138.8f50bb93.js"><link rel="prefetch" href="/assets/js/139.83f80acb.js"><link rel="prefetch" href="/assets/js/14.5e1b322f.js"><link rel="prefetch" href="/assets/js/140.255a8042.js"><link rel="prefetch" href="/assets/js/141.a7ad537d.js"><link rel="prefetch" href="/assets/js/142.b0c92d9c.js"><link rel="prefetch" href="/assets/js/143.f15b1f80.js"><link rel="prefetch" href="/assets/js/144.813a5a2e.js"><link rel="prefetch" href="/assets/js/145.b7069ddf.js"><link rel="prefetch" href="/assets/js/146.9fcc40e8.js"><link rel="prefetch" href="/assets/js/147.654c12e8.js"><link rel="prefetch" href="/assets/js/148.d2104b86.js"><link rel="prefetch" href="/assets/js/149.16115bff.js"><link rel="prefetch" href="/assets/js/15.c64a0296.js"><link rel="prefetch" href="/assets/js/150.e19d3aa4.js"><link rel="prefetch" href="/assets/js/151.e1e9732d.js"><link rel="prefetch" href="/assets/js/152.e4d9ed7c.js"><link rel="prefetch" href="/assets/js/153.720bddec.js"><link rel="prefetch" href="/assets/js/154.6d76f159.js"><link rel="prefetch" href="/assets/js/155.56639bb5.js"><link rel="prefetch" href="/assets/js/156.1b1456ad.js"><link rel="prefetch" href="/assets/js/157.41735b3f.js"><link rel="prefetch" href="/assets/js/158.2f7e2a71.js"><link rel="prefetch" href="/assets/js/159.8ecf5123.js"><link rel="prefetch" href="/assets/js/16.f13c1a4b.js"><link rel="prefetch" href="/assets/js/160.dd6f3d5e.js"><link rel="prefetch" href="/assets/js/161.ba4d9a7f.js"><link rel="prefetch" href="/assets/js/162.297aea0d.js"><link rel="prefetch" href="/assets/js/163.e34450b7.js"><link rel="prefetch" href="/assets/js/164.34381886.js"><link rel="prefetch" href="/assets/js/165.d4c2775d.js"><link rel="prefetch" href="/assets/js/166.c4c9cefb.js"><link rel="prefetch" href="/assets/js/167.d323a0a9.js"><link rel="prefetch" href="/assets/js/168.c20012b9.js"><link rel="prefetch" href="/assets/js/169.3cfddb83.js"><link rel="prefetch" href="/assets/js/17.e99ac461.js"><link rel="prefetch" href="/assets/js/170.3d3526f6.js"><link rel="prefetch" href="/assets/js/171.bba7cce9.js"><link rel="prefetch" href="/assets/js/172.8fbda3bd.js"><link rel="prefetch" href="/assets/js/173.1532f8d6.js"><link rel="prefetch" href="/assets/js/174.638e5e0a.js"><link rel="prefetch" href="/assets/js/175.d8d82e12.js"><link rel="prefetch" href="/assets/js/176.4b3a122c.js"><link rel="prefetch" href="/assets/js/177.3d9e6e89.js"><link rel="prefetch" href="/assets/js/178.58b1bf9b.js"><link rel="prefetch" href="/assets/js/179.3fc5f21a.js"><link rel="prefetch" href="/assets/js/18.2df0d7da.js"><link rel="prefetch" href="/assets/js/180.436cb2b1.js"><link rel="prefetch" href="/assets/js/181.dadcbdd8.js"><link rel="prefetch" href="/assets/js/182.d7f00bd5.js"><link rel="prefetch" href="/assets/js/183.b6a49ebe.js"><link rel="prefetch" href="/assets/js/184.72f1e1df.js"><link rel="prefetch" href="/assets/js/185.a30e0b04.js"><link rel="prefetch" href="/assets/js/186.a89aa666.js"><link rel="prefetch" href="/assets/js/187.c7601a79.js"><link rel="prefetch" href="/assets/js/188.47d25cdd.js"><link rel="prefetch" href="/assets/js/189.a5220877.js"><link rel="prefetch" href="/assets/js/19.74c2fe85.js"><link rel="prefetch" href="/assets/js/190.7fea63c8.js"><link rel="prefetch" href="/assets/js/191.79188b69.js"><link rel="prefetch" href="/assets/js/192.91858bc5.js"><link rel="prefetch" href="/assets/js/193.f8c9dc11.js"><link rel="prefetch" href="/assets/js/194.db5d514f.js"><link rel="prefetch" href="/assets/js/195.a21dfa21.js"><link rel="prefetch" href="/assets/js/196.3deca662.js"><link rel="prefetch" href="/assets/js/197.a26c6a57.js"><link rel="prefetch" href="/assets/js/198.199de2a9.js"><link rel="prefetch" href="/assets/js/199.3a93f5fd.js"><link rel="prefetch" href="/assets/js/20.37ef7b5a.js"><link rel="prefetch" href="/assets/js/200.2e0ca284.js"><link rel="prefetch" href="/assets/js/201.43159287.js"><link rel="prefetch" href="/assets/js/202.47ac18b9.js"><link rel="prefetch" href="/assets/js/21.8edf360c.js"><link rel="prefetch" href="/assets/js/22.681f9ff8.js"><link rel="prefetch" href="/assets/js/23.102f38f3.js"><link rel="prefetch" href="/assets/js/24.0d068097.js"><link rel="prefetch" href="/assets/js/25.b8c6fba0.js"><link rel="prefetch" href="/assets/js/26.b76fcccf.js"><link rel="prefetch" href="/assets/js/27.b95d8356.js"><link rel="prefetch" href="/assets/js/28.425d53a0.js"><link rel="prefetch" href="/assets/js/29.49ae4d56.js"><link rel="prefetch" href="/assets/js/30.268326de.js"><link rel="prefetch" href="/assets/js/31.d1322ccd.js"><link rel="prefetch" href="/assets/js/32.6baff7b9.js"><link rel="prefetch" href="/assets/js/33.91599495.js"><link rel="prefetch" href="/assets/js/34.7d1e8694.js"><link rel="prefetch" href="/assets/js/35.a28b2867.js"><link rel="prefetch" href="/assets/js/36.926c21b7.js"><link rel="prefetch" href="/assets/js/38.c07a024e.js"><link rel="prefetch" href="/assets/js/39.23ab4214.js"><link rel="prefetch" href="/assets/js/4.79366a86.js"><link rel="prefetch" href="/assets/js/40.47c89362.js"><link rel="prefetch" href="/assets/js/41.0e9b77b3.js"><link rel="prefetch" href="/assets/js/42.e93c36a9.js"><link rel="prefetch" href="/assets/js/43.8e4bef73.js"><link rel="prefetch" href="/assets/js/44.f5808021.js"><link rel="prefetch" href="/assets/js/45.3afe2dae.js"><link rel="prefetch" href="/assets/js/46.f597a77f.js"><link rel="prefetch" href="/assets/js/47.11f2d487.js"><link rel="prefetch" href="/assets/js/48.7fef6ef8.js"><link rel="prefetch" href="/assets/js/49.b2d21efe.js"><link rel="prefetch" href="/assets/js/5.9ee91412.js"><link rel="prefetch" href="/assets/js/50.5832583c.js"><link rel="prefetch" href="/assets/js/51.54c00e7a.js"><link rel="prefetch" href="/assets/js/52.bd5535f0.js"><link rel="prefetch" href="/assets/js/53.0d38f84a.js"><link rel="prefetch" href="/assets/js/54.65144b95.js"><link rel="prefetch" href="/assets/js/55.368817a9.js"><link rel="prefetch" href="/assets/js/56.04e15523.js"><link rel="prefetch" href="/assets/js/57.b41a7dc6.js"><link rel="prefetch" href="/assets/js/58.0f0d92dd.js"><link rel="prefetch" href="/assets/js/59.e7dddc9e.js"><link rel="prefetch" href="/assets/js/6.b921ef33.js"><link rel="prefetch" href="/assets/js/60.4038bd0b.js"><link rel="prefetch" href="/assets/js/61.5d51e956.js"><link rel="prefetch" href="/assets/js/62.786b095c.js"><link rel="prefetch" href="/assets/js/63.9da19a49.js"><link rel="prefetch" href="/assets/js/64.48f50f07.js"><link rel="prefetch" href="/assets/js/65.0fd7ee4a.js"><link rel="prefetch" href="/assets/js/66.5d68a363.js"><link rel="prefetch" href="/assets/js/67.f4882da2.js"><link rel="prefetch" href="/assets/js/68.224daefc.js"><link rel="prefetch" href="/assets/js/69.420801b1.js"><link rel="prefetch" href="/assets/js/7.e128bbee.js"><link rel="prefetch" href="/assets/js/70.1e62f96f.js"><link rel="prefetch" href="/assets/js/71.62f9fa7c.js"><link rel="prefetch" href="/assets/js/72.ad20df74.js"><link rel="prefetch" href="/assets/js/73.e16fef7c.js"><link rel="prefetch" href="/assets/js/74.c1f72d12.js"><link rel="prefetch" href="/assets/js/75.e1f28980.js"><link rel="prefetch" href="/assets/js/76.2c304c87.js"><link rel="prefetch" href="/assets/js/77.7265d1f0.js"><link rel="prefetch" href="/assets/js/78.c7c2fdd3.js"><link rel="prefetch" href="/assets/js/79.0be55b5d.js"><link rel="prefetch" href="/assets/js/8.b17d0b27.js"><link rel="prefetch" href="/assets/js/80.3c460019.js"><link rel="prefetch" href="/assets/js/81.972b58cd.js"><link rel="prefetch" href="/assets/js/82.6c4d50e0.js"><link rel="prefetch" href="/assets/js/83.89ff3b39.js"><link rel="prefetch" href="/assets/js/84.5629cfb0.js"><link rel="prefetch" href="/assets/js/85.78a9bc3f.js"><link rel="prefetch" href="/assets/js/86.b429e7fb.js"><link rel="prefetch" href="/assets/js/87.5c3ba926.js"><link rel="prefetch" href="/assets/js/88.52737753.js"><link rel="prefetch" href="/assets/js/89.696bb63f.js"><link rel="prefetch" href="/assets/js/9.0874a43d.js"><link rel="prefetch" href="/assets/js/90.60296dbe.js"><link rel="prefetch" href="/assets/js/91.2d2fd4df.js"><link rel="prefetch" href="/assets/js/92.d860f080.js"><link rel="prefetch" href="/assets/js/93.b341ebd9.js"><link rel="prefetch" href="/assets/js/94.ebd37258.js"><link rel="prefetch" href="/assets/js/95.15dbfc06.js"><link rel="prefetch" href="/assets/js/96.041d049b.js"><link rel="prefetch" href="/assets/js/97.e22ed305.js"><link rel="prefetch" href="/assets/js/98.2e23ad42.js"><link rel="prefetch" href="/assets/js/99.e886cd85.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d4a3a82a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar shadow"><div class="con-btns-header"><a href="/" class="home-link router-link-active"><div class="con-logo"><!----> <span class="site-name">Fellow Travellers</span></div></a> <div class="links"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link" data-v-e7cf42d2>主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">三维</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-tech3d/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/language/Micro-frontend_Start.html" class="nav-link" data-v-e7cf42d2>开发语言</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/production/" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/codelab/Principle_of_Visualizatio_for_WebGL.html" class="nav-link" data-v-e7cf42d2>专题</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/other/SuperMap_Questions_and_Answer.html" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-frontend/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/base/EC_ScopChain_Closure.html" class="nav-link" data-v-e7cf42d2>开发基础</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/web-gis/" class="nav-link" data-v-e7cf42d2>WebGIS开发</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/solution/" class="nav-link" data-v-e7cf42d2>解决方案</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/best-practice/" class="nav-link" data-v-e7cf42d2>最佳实践</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/arithmetic/QuickSort.html" class="nav-link" data-v-e7cf42d2>算法</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">移动</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-mobile/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/dataResource/sourceCodeLib.html" class="nav-link" data-v-e7cf42d2>数据资源</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/product/nativeApp.html" class="nav-link" data-v-e7cf42d2>产品分型</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/appStore/" class="nav-link" data-v-e7cf42d2>应用商店</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/other/designDocument.html" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-calc3d/start/XinShouShouCe.html" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/gis/Base_ZBX_ZongJie.html" class="nav-link" data-v-e7cf42d2>GIS</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/database/Oracle_LostSysPassword.html" class="nav-link" data-v-e7cf42d2>数据库</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/language/" class="nav-link" data-v-e7cf42d2>开发语言</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/codelab/" class="nav-link" data-v-e7cf42d2>源码库</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/production/DDP_ArcGIS_BuShuShouCe.html" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后台</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-backend/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/database/Mongoazyx.html" class="nav-link" data-v-e7cf42d2>数据库</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/framework/Git.html" class="nav-link" data-v-e7cf42d2>开发基础</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/production/" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础研发</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-base/dist-utils/API.html" class="nav-link" data-v-e7cf42d2>dist-utils</a></li><li class="dropdown-item"><!----> <a href="http://192.168.200.39:18088/EyeMapAPI/" target="_blank" rel="noopener noreferrer" class="nav-link" data-v-e7cf42d2>eyemap业务库</a></li><li class="dropdown-item"><!----> <a href="/doc-base/stylelint-config/" class="nav-link" data-v-e7cf42d2>stylelint-config</a></li></ul></div></div><div class="nav-item"><a href="/doc-share/SuperMap_Pipe3DStrategy.html" class="nav-link" data-v-e7cf42d2>分享</a></div><div class="nav-item"><a href="https://fellowtravellers.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link" data-v-e7cf42d2>社区</a></div><div class="nav-item"><a href="/doc-help/mdRule.html" class="nav-link" data-v-e7cf42d2>帮助</a></div></nav></div></div> <div class="con-redes-download"><a title="GitLab" href="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335/" target="_blank" rel="noopener noreferrer" class="repo-link flaticon-github"></a></div></header> <div class="sidebar-map"><div class="c-sidebar-map"><ul class="sidebar-links-map"><li><div class="sidebar-group first"><ul class="sidebar-group-items"><li><a href="/doc-backend/framework/Git.html" class="sidebar-link siderbar-map-item">GIT 使用介绍</a></li><li><a href="/doc-backend/framework/Jar.html" class="sidebar-link siderbar-map-item">Jar 包那些事</a></li><li><a href="/doc-backend/framework/Jar2.html" aria-current="page" class="active sidebar-link siderbar-map-item">Jar 包那些事 2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#引言" class="sidebar-link siderbar-map-item">引言</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#科普-1-urlstreamhandler" class="sidebar-link siderbar-map-item">科普 1 —— URLStreamHandler</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#科普-2-fatjar" class="sidebar-link siderbar-map-item">科普 2 —— FatJar</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#archive-的概念" class="sidebar-link siderbar-map-item">Archive 的概念</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#jarfile" class="sidebar-link siderbar-map-item">JarFile</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#jarlauncher-源码" class="sidebar-link siderbar-map-item">JarLauncher 源码</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#launchedurlclassloader" class="sidebar-link siderbar-map-item">LaunchedURLClassLoader</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#org-springframework-boot-loader-jar-handler" class="sidebar-link siderbar-map-item">org.springframework.boot.loader.jar.Handler</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#总结" class="sidebar-link siderbar-map-item">总结</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#扩展" class="sidebar-link siderbar-map-item">扩展</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#本文参考" class="sidebar-link siderbar-map-item">本文参考</a></li></ul></li><li><a href="/doc-backend/framework/JavaClassLoader.html" class="sidebar-link siderbar-map-item">浅析 Java 类加载器</a></li><li><a href="/doc-backend/framework/k8s.html" class="sidebar-link siderbar-map-item">k8s 简介</a></li><li><a href="/doc-backend/framework/Maven.html" class="sidebar-link siderbar-map-item">Maven 那点不为人知的事</a></li><li><a href="/doc-backend/framework/nginx-start.html" class="sidebar-link siderbar-map-item">nginx 简介</a></li><li><a href="/doc-backend/framework/session.html" class="sidebar-link siderbar-map-item">单点登录 —— session共享</a></li><li><a href="/doc-backend/framework/oauth2.html" class="sidebar-link siderbar-map-item">OAuth2 简介</a></li></ul></div></li></ul> </div></div> <div class="sidebar"><div class="c-sidebar"> <div class="search-box"><input aria-label="Search" placeholder="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>开发基础</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/doc-backend/framework/Git.html" class="sidebar-link">GIT 使用介绍</a></li><li><a href="/doc-backend/framework/Jar.html" class="sidebar-link">Jar 包那些事</a></li><li><a href="/doc-backend/framework/Jar2.html" aria-current="page" class="active sidebar-link">Jar 包那些事 2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#引言" class="sidebar-link">引言</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#科普-1-urlstreamhandler" class="sidebar-link">科普 1 —— URLStreamHandler</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#科普-2-fatjar" class="sidebar-link">科普 2 —— FatJar</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#archive-的概念" class="sidebar-link">Archive 的概念</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#jarfile" class="sidebar-link">JarFile</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#jarlauncher-源码" class="sidebar-link">JarLauncher 源码</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#launchedurlclassloader" class="sidebar-link">LaunchedURLClassLoader</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#org-springframework-boot-loader-jar-handler" class="sidebar-link">org.springframework.boot.loader.jar.Handler</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#扩展" class="sidebar-link">扩展</a></li><li class="sidebar-sub-header"><a href="/doc-backend/framework/Jar2.html#本文参考" class="sidebar-link">本文参考</a></li></ul></li><li><a href="/doc-backend/framework/JavaClassLoader.html" class="sidebar-link">浅析 Java 类加载器</a></li><li><a href="/doc-backend/framework/k8s.html" class="sidebar-link">k8s 简介</a></li><li><a href="/doc-backend/framework/Maven.html" class="sidebar-link">Maven 那点不为人知的事</a></li><li><a href="/doc-backend/framework/nginx-start.html" class="sidebar-link">nginx 简介</a></li><li><a href="/doc-backend/framework/session.html" class="sidebar-link">单点登录 —— session共享</a></li><li><a href="/doc-backend/framework/oauth2.html" class="sidebar-link">OAuth2 简介</a></li></ul></div></li></ul> </div></div> <!----> <!----> <div class="page"><div class="content-pagex content content__default"><h2 id="引言"><a href="#引言" class="header-anchor">#</a> 引言</h2> <p>在做项目的时候写了以下代码，直接在 IDE 中运行发现是没有问题的，但是打成 jar 包运行就出现了文件没有找到的错误。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// jar:file:/Users/x5456/IdeaProjects/spring-test/target/ars.jar!/BOOT-INF/classes!/application.yml</span>
<span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token class-name">SpringTestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/application.yml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// jar包执行时抛出空指针异常。</span>
<span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其实仔细想一想就知道是什么原因了，是因为 FileInputStream 无法解析 <code>!/</code> 从而无法读取到 jar 包中的文件，所以之后采用了下面这种写法，代码就可以正常执行了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token class-name">SpringTestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/application.yml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>那么为什么这种方式就可以正常获取到流呢，它内部的实现和第一种有啥不同吗？我们来探索一下，测试代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">&quot;jar:file:/Users/x5456/IdeaProjects/spring-test/target/ars.jar!/BOOT-INF/classes/application.yml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgbk12uz8j31700b2wh6.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgbni277ej316c0biq5p.jpg" alt=""></p> <p>先看一下 handler 是在什么时候赋值的吧：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgbyci1j6j31cy0f0n0n.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgc0nzqlzj31iq0u0n61.jpg" alt=""></p> <p>好，我们继续看下 handler.openConnection() 做了什么吧</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgc3h50dqj31ns0m479h.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgc5iuqftj31gy0p6ags.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgcbdmwlnj31ta0u0dqb.jpg" alt=""></p> <p>接下来看下它的 getInputStream() 方法：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgd6nmq2hj31ss0k244j.jpg" alt=""></p> <h3 id="tag1"><a href="#tag1" class="header-anchor">#</a> tag1</h3> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgd2nm2pfj31my0u0n4x.jpg" alt=""></p> <h3 id="tag2"><a href="#tag2" class="header-anchor">#</a> tag2</h3> <p>想看的自己看吧，我逃了^v^。</p> <h2 id="科普-1-urlstreamhandler"><a href="#科普-1-urlstreamhandler" class="header-anchor">#</a> 科普 1 —— URLStreamHandler</h2> <p>URLStreamHandler 的主要作用就是打开各种各样的资源（http、ftp、file 等）的链接。</p> <p>Java 中使用 URL 来描述资源，而 URL 有一个方法 URL#openConnection() 用于打开链接。由于 URL 用于表达各种各样的资源，打开资源的具体动作由 java.net.URLStreamHandler 这个类的子类来完成。根据不同的协议，会有不同的 handler 实现。而 JDK 内置了相当多的 handler 实现用于应对不同的协议，比如 jar、file、http 等。</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdn1eubej30es0b4wfi.jpg" alt=""></p> <p>URL 内部有一个静态 HashTable 属性，用于保存已经被发现的协议和 handler 实例的映射。</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdivfjmlj319e08k75d.jpg" alt=""></p> <p>使用自定义的 URLStreamHandler 有以下两种方法：</p> <ol><li>实现 URLStreamHandlerFactory 接口，通过方法 URL.setURLStreamHandlerFactory() 将其设置进去。该属性是一个静态属性，且只能被设置一次。JDK 有一个 URLStreamHandlerFactory 实现（但是不知道在哪用到）如下：</li></ol> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdqenvcrj31na0r0gqi.jpg" alt=""></p> <ol start="2"><li>直接提供 URLStreamHandler 的子类，作为 URL 的构造方法的入参之一</li></ol> <blockquote><p>注：在 JVM 中对 URLStreamHandler 的子类有固定的规范要求：子类的类名必须是 Handler，同时最后一级的包名必须是协议的名称。比如自定义了 Http 的协议实现，则类名必然为 xx.http.Handler；而且在 JVM 启动的时候，需要设置 java.protocol.handler.pkgs 系统属性，如果有多个实现类，那么中间用|隔开。因为 JVM 在尝试寻找 Handler 时，会从这个属性中获取包名前缀，最终使用包名前缀.协议名.Handler，使用 Class.forName 方法尝试初始化类，如果初始化成功，则会使用该类的实现作为协议实现。</p> <p>示例：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdvbcy1cj314e0i4wii.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdvjecwoj323g0h4td0.jpg" alt=""></p></blockquote> <h2 id="科普-2-fatjar"><a href="#科普-2-fatjar" class="header-anchor">#</a> 科普 2 —— FatJar</h2> <p>什么是 Fat Jar？</p> <p>简单地说就是胖 Jar 呗！哈哈！就是说这个 Jar 所装的东西比一般的 Jar 要多嘛！一般地，我们通过 maven 的插件 maven-jar-plugin 所打包生成的 jar 都是只包含我们项目的源码的，它不包含我们所依赖的第三方库，这样就会导致一个问题，如果我们的第三方库不在 CLASSPATH 下面会怎样？当然是会出现 java.lang.NoClassDefFoundError 的问题咯！因此，我们需要使用一种方式，能使得项目所依赖的第三方库能够随着我们的项目源码一起被打包，这样我们就完全不用担心类找不到的问题啦！这就是 Fat Jar 的来历！</p> <p>如何打出 Fat Jar？</p> <p>生成 Fat Jar 我们使用的是 One-Jar 这个 Maven 插件。具体配置代码如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>finalName</span><span class="token punctuation">&gt;</span></span>fat-jar-example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>finalName</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-jar-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>cn.x5456.TestCanRunJar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.jolira<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>onejar-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>one-jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCanRunJar</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;{}是只小傻狗&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;哒哒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">TestCanRunJar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">TestCanRunJar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>java -jar fat-jar-example.one-jar.jar
哒哒是只小傻狗
com.simontuffs.onejar.JarClassLoader@610455d6
com.simontuffs.onejar.JarClassLoader@610455d6
sun.misc.Launcher<span class="token variable">$AppClassLoader</span>@42a57993       <span class="token comment"># 他的父类加载器为加载</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过输出结果我们发现，我们的类加载器好像并不是使用的默认的 AppClassLoader，而是使用的 <code>com.simontuffs.onejar.JarClassLoader</code>，我们代码中并没有这个类啊，这个类是哪来的呢，我们解压下打包出来的 fat jar，看下它的文件结构：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>tree fat-jar-example.one-jar
fat-jar-example.one-jar
├── META-INF
│   └── MANIFEST.MF
├── OneJar.class
├── com
│   └── simontuffs
│       └── onejar
│           ├── Boot<span class="token variable">$1</span>.class
│           ├── Boot<span class="token variable">$2</span>.class
│           ├── Boot<span class="token variable">$3</span>.class
│           ├── Boot.class      <span class="token comment"># 由 MANIFEST.MF 得知启动类是 Boot</span>
│           ├── Handler<span class="token variable">$1</span>.class
│           ├── Handler.class   <span class="token comment"># 自定义了一个 onejar 协议，实现了 URLStreamHandler#openConnection() 方法，通过这个方法我们可以在获取到 URL 对象的时候拿到他的 inputStream</span>
│           ├── IProperties.class
│           ├── JarClassLoader<span class="token variable">$1</span>.class
│           ├── JarClassLoader<span class="token variable">$2</span>.class
│           ├── JarClassLoader<span class="token variable">$ByteCode</span>.class
│           ├── JarClassLoader<span class="token variable">$FileURLFactory</span><span class="token variable">$1</span>.class
│           ├── JarClassLoader<span class="token variable">$FileURLFactory</span>.class
│           ├── JarClassLoader<span class="token variable">$IURLFactory</span>.class
│           ├── JarClassLoader<span class="token variable">$OneJarURLFactory</span>.class
│           ├── JarClassLoader.class    <span class="token comment"># 自定义的类加载器，用于加载 lib 和 main 目录下的 jar 包</span>
│           ├── OneJarFile<span class="token variable">$1</span>.class
│           ├── OneJarFile<span class="token variable">$2</span>.class
│           ├── OneJarFile.class
│           └── OneJarURLConnection.class
├── lib
│   └── hutool-all-4.6.1.jar    <span class="token comment"># 项目依赖的 jar 包</span>
└── main
    └── fat-jar-example.jar     <span class="token comment"># 打出的可执行 jar</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>感兴趣的可以自行看一下源码，因为没有办法运行，我也不知道我说的对不对，反正就是启动的时候，Boot 调用 JarClassLoader 的 load 方法，将需要加载的类和 jar 包加载到内存中（byte[]），当用到的时候从中查找并 defineClass。</p> <h1 id="springboot-基于-jar-包启动流程"><a href="#springboot-基于-jar-包启动流程" class="header-anchor">#</a> SpringBoot 基于 jar 包启动流程</h1> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjka9rd15j31sk07i41s.jpg" alt=""></p> <p>上篇文章我们说了为啥 MANIFEST.MF 文件中的 Main-Class 是 XXXLauncher，我们今天就介绍一下 JarLauncher 吧。为了看这部分代码，我们需要引入<code>spring-boot-loader</code>的依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-loader<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="archive-的概念"><a href="#archive-的概念" class="header-anchor">#</a> Archive 的概念</h2> <p>SpringBoot 抽象了 Archive 的概念，一个 Archive 可以是 jar（JarFileArchive），可以是一个文件目录（ExplodedArchive），可以抽象为统一访问资源的逻辑层。</p> <p>Spring Boot 中 Archive 的源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Archive</span> <span class="token keyword">extends</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Archive</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>

	<span class="token comment">/**
	 * 获取该归档的url
	 */</span>
	<span class="token class-name">URL</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 获取jar!/META-INF/MANIFEST.MF或[ArchiveDir]/META-INF/MANIFEST.MF
	 */</span>
	<span class="token class-name">Manifest</span> <span class="token function">getManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 获取嵌套档案，即 jar!/BOOT-INF/lib/*.jar或[ArchiveDir]/BOOT-INF/lib/*.jar
	 */</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Archive</span><span class="token punctuation">&gt;</span></span> <span class="token function">getNestedArchives</span><span class="token punctuation">(</span><span class="token class-name">EntryFilter</span> filter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * Closes the {@code Archive}, releasing any open resources.
	 * @throws Exception if an error occurs during close processing
	 * @since 2.2.0
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 代表档案（jar包或文件夹）中的资源文件
	 */</span>
	<span class="token keyword">interface</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>

		<span class="token comment">/**
		 * Returns {@code true} if the entry represents a directory.
		 * @return if the entry is a directory
		 */</span>
		<span class="token keyword">boolean</span> <span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/**
		 * Returns the name of the entry.
		 * @return the name of the entry
		 */</span>
		<span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * Strategy interface to filter {@link Entry Entries}.
	 */</span>
	<span class="token keyword">interface</span> <span class="token class-name">EntryFilter</span> <span class="token punctuation">{</span>

		<span class="token comment">/**
		 * Apply the jar entry filter.
		 * @param entry the entry to filter
		 * @return {@code true} if the filter matches
		 */</span>
		<span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Entry</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>该接口有两个实现，分别是 org.springframework.boot.loader.archive.ExplodedArchive 和 org.springframework.boot.loader.archive.JarFileArchive。前者用于在文件夹目录下寻找资源，后者用于在 jar 包环境下寻找资源。</p> <h2 id="jarfile"><a href="#jarfile" class="header-anchor">#</a> JarFile</h2> <p>对 jar 包的封装，每个 JarFileArchive 都会对应一个 JarFile。<strong>JarFile 被构造的时候会解析内部结构，去获取 jar 包里的各个文件或文件夹，这些文件或文件夹会被封装到 Entry 中</strong>。</p> <p>这个 JarFile 有很多 Entry，比如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>META-INF/
META-INF/MANIFEST.MF
spring/
spring/study/
....
spring/study/executablejar/ExecutableJarApplication.class
lib/spring-boot-starter-1.3.5.RELEASE.jar
lib/spring-boot-1.3.5.RELEASE.jar
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其他（我表示没看懂）：<a href="https://www.kancloud.cn/george96/java-springboot/614072" target="_blank" rel="noopener noreferrer">附录 D.2. Spring Boot 的&quot;JarFile&quot;类<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="jarlauncher-源码"><a href="#jarlauncher-源码" class="header-anchor">#</a> JarLauncher 源码</h2> <p>类图</p> <p><img src="https://res.cloudinary.com/incoder/image/upload/v1562399159/blog/jarlauncher.png" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjlhq6jj7j30u00u7tgr.jpg" alt=""></p> <p>先看下它父类的构造</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ExecutableArchiveLauncher</span> <span class="token keyword">extends</span> <span class="token class-name">Launcher</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Archive</span> archive<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ExecutableArchiveLauncher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 主要就是将当前类所在的 jar 或者路径，创建一个 Archive 对象</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>archive <span class="token operator">=</span> <span class="token function">createArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Archive</span> <span class="token function">createArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token class-name">ProtectionDomain</span> protectionDomain <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProtectionDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">CodeSource</span> codeSource <span class="token operator">=</span> protectionDomain<span class="token punctuation">.</span><span class="token function">getCodeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">URI</span> location <span class="token operator">=</span> <span class="token punctuation">(</span>codeSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> codeSource<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token punctuation">(</span>location <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> location<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to determine code source archive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">File</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to determine code source archive from &quot;</span> <span class="token operator">+</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 根据代码所在路径封装成不同的档案类型，毕竟有两种运行方式嘛：</span>
        <span class="token comment">// java org/springframework/boot/loader/JarLauncher path -&gt; /Users/x5456/IdeaProjects/canRunJar/target/classes/</span>
        <span class="token comment">// java -jar ars.jar                                path -&gt; /Users/x5456/IdeaProjects/canRunJar/target/jarstarter.jar</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ExplodedArchive</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">JarFileArchive</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>再看下 Launcher#launch() 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">{</span>

	<span class="token comment">/**
	 * 启动应用程序。 此方法是子类public static void main(String[] args)方法应调用的初始入口点。
	 * @param args the incoming arguments
	 * @throws Exception if the application fails to launch
	 */</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">launch</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1）扩展 Jar 协议</span>
		<span class="token class-name">JarFile</span><span class="token punctuation">.</span><span class="token function">registerUrlProtocolHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2）创建一个新的 ClassLoader</span>
		<span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassPathArchives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3）将新的 ClassLoader 放入线程上下文中，并执行 MANIFEST.MF 文件里面 Statr-Class 属性指定类的 main 方法</span>
		<span class="token function">launch</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token function">getMainClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_1）扩展-jar-协议"><a href="#_1）扩展-jar-协议" class="header-anchor">#</a> 1）扩展 Jar 协议</h3> <p>为什么需要扩展 jar 协议呢？</p> <ol><li>因为我们引入的 jar 包中可能用到了自己类路径下的文件，此时他的 path 就可能是这样的：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>jar:file:/Users/x5456/IdeaProjects/spring-test/target/ars.jar!/BOOT-INF/lib/canRunJar-1.0-SNAPSHOT.jar!/aaa.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中有两个<code>!/</code>，而默认的 jar 协议对应的 Handler 无法通过这样的路径打开链接，所以需要我们对其进行扩展，从而实现对 jar in jar 中**资源（包括字节码和资源文件）**的加载。</p> <ol start="2"><li>【非主要，其它实现也有不用 Handler 来做到的】Spring 通过自定义的 Handler 来复用 ClassLoader 原有的代码，使其支持获取 jar in jar 中的字节码文件。</li></ol> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmgdvjecwoj323g0h4td0.jpg" alt=""></p> <h3 id="_2）创建一个新的-classloader"><a href="#_2）创建一个新的-classloader" class="header-anchor">#</a> 2）创建一个新的 ClassLoader</h3> <p>为什么要创建新的 ClassLoader 呢？</p> <ol><li>因为 AppClassLoader 无法加载 jar 包中的 jar 包（可能是没有办法把带<code>!/</code>的路径当做类加载路径吧）</li> <li>因为他将编译出的字节码放在了 BOOT-INF/classes 目录下。</li></ol> <blockquote><p>对于 Java 标准的 jar 文件来说，规定在一个 jar 文件中，我们必须要将指定 main.class 的类直接放置在文件的顶层目录中（也就是说，它不予许被嵌套），否则将无法加载，对于 BOOT-INF/class/路径下的 class 因为不在顶层目录，因此也是无法直接进行加载， 而对于 BOOT-INF/lib/ 路径的 jar 属于嵌套的（Fatjar），也是不能直接加载，因此 Spring 要想启动加载，就需要自定义实现自己的类加载器去加载。</p></blockquote> <p>源码解析：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjriduzm8j31980f241o.jpg" alt=""></p> <h4 id="tag1-getclasspatharchives"><a href="#tag1-getclasspatharchives" class="header-anchor">#</a> tag1 getClassPathArchives()</h4> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjrwle8t6j31n00hkteb.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjrykqxyej319i0gsdjc.jpg" alt=""></p> <blockquote><p>注：此处生成的 Archive 集合包含：一个 BOOT-INF/classes 目录的 Archive（classes 目录是一个 Archive） 和 BOOT-INF/lib 目录下 jar 包的 Archive（每个 jar 包是一个 Archive）。</p></blockquote> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjunsjiwsj316j0u0wod.jpg" alt=""></p> <blockquote><p>System.getproperty(&quot;java.io.tmpdir&quot;) 是获取操作系统缓存的临时目录，不同操作系统的缓存临时目录不一样：</p> <p>Windows 的缓存目录为：C:\Users\登录用户~1\AppData\Local\Temp\</p> <p>Linux：/tmp</p> <p>Mac：/var/folders/28/1tyh6prj3xg6xcdx_3qlkwr80000gn/T/</p></blockquote> <p>但我为啥觉得他只能处理 3 层嵌套，再多了就不行了，不往下看了，不知道多层嵌套 jar 的这种情况是怎么出现的。</p> <h4 id="tag2-createclassloader-list-archives"><a href="#tag2-createclassloader-list-archives" class="header-anchor">#</a> tag2 createClassLoader(List archives)</h4> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjs2eo0dkj31ca0mon2c.jpg" alt=""></p> <h5 id="tag2-1-archive-geturl"><a href="#tag2-1-archive-geturl" class="header-anchor">#</a> tag2.1 archive.getUrl()</h5> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjs8r1s5oj31fw0ekwi7.jpg" alt=""></p> <p>当前类的类加载器为 AppClassLoader。</p> <h5 id="tag2-2-new-launchedurlclassloader-urls-classloader"><a href="#tag2-2-new-launchedurlclassloader-urls-classloader" class="header-anchor">#</a> tag2.2 new LaunchedURLClassLoader(urls, classLoader)</h5> <p>参见 LaunchedURLClassLoader</p> <h3 id="_3）将新的-classloader-放入线程上下文中，并执行-manifest-mf-文件里面-statr-class-属性指定类的-main-方法"><a href="#_3）将新的-classloader-放入线程上下文中，并执行-manifest-mf-文件里面-statr-class-属性指定类的-main-方法" class="header-anchor">#</a> 3）将新的 ClassLoader 放入线程上下文中，并执行 MANIFEST.MF 文件里面 Statr-Class 属性指定类的 main 方法</h3> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjt8f9cc2j31ko0fujui.jpg" alt=""></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjt8u2y5ij31ly0ny78q.jpg" alt=""></p> <h2 id="launchedurlclassloader"><a href="#launchedurlclassloader" class="header-anchor">#</a> LaunchedURLClassLoader</h2> <p>LaunchedURLClassLoader 继承了 URLClassLoader 主要重写了他的 loaderClass 方法，我们先看下它的构造：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjsnd7yabj318w0l0jvh.jpg" alt=""></p> <p>再看下它的 loaderClass 方法：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjslsgoilj31qw0te46i.jpg" alt=""></p> <h3 id="tag1-definepackageifnecessary-string-classname"><a href="#tag1-definepackageifnecessary-string-classname" class="header-anchor">#</a> tag1 definePackageIfNecessary(String className)</h3> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjsuskb3ej318f0u04bl.jpg" alt=""></p> <h3 id="tag2-loaderclass"><a href="#tag2-loaderclass" class="header-anchor">#</a> tag2 loaderClass()</h3> <p>loaderClass() 方法之前已经分析过了，主要做了双亲委派，其中与当前类加载器相关的方法时 findClass() 方法：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjsx4ist1j319v0u0wm3.jpg" alt=""></p> <p>由于源码比较深，直接给大家看结果：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmjsypm0zej31fb0u0q9s.jpg" alt=""></p> <h2 id="org-springframework-boot-loader-jar-handler"><a href="#org-springframework-boot-loader-jar-handler" class="header-anchor">#</a> org.springframework.boot.loader.jar.Handler</h2> <p>如果有 jar 包中包含 jar，或者 jar 包中包含 jar 包里面的 class 文件，那么会使用 <code>!/</code>分隔开，这种方式只有 org.springframework.boot.loader.jar.Handler 能处理，它是 SpringBoot 内部扩展出来的一种 URL 协议。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>各个组件的作用：</p> <ul><li><p>Jar/WarLaucher 定义扫描 jar 包和字节码的类路径</p></li> <li><p>扩展了 java.util.jar.JarFile、URLStreamHandler、java.net.JarURLConnection 实现了 jar in jar 中资源的加载。</p></li> <li><p>通过自定义类加载器 LauncherURLClassLoader，实现了 jar in jar 中 class 文件的加载。</p></li> <li><p>JarFileArchive 相当于 JarFile 的适配器，适配了 Archive 接口，当然他内部逻辑也有很多。</p> <ul><li>对于多重 jar in jar，实际上是解压到了临时目录来处理，可以参考 JarFileArchive 里的代码。</li></ul></li></ul> <h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <p>本文是采用<code>this.getClass().getResource(&quot;/&quot;)</code>获取的类路径地址，得到的是带<code>!/</code>的路径，那么采用<code>request.getServletContext().getRealPath(&quot;/&quot;);</code>获取到的地址是什么样的呢，经过测试发现，他会在使用 java -jar 命令的主机上新建一个缓存路径，在我的 mac 上路径就是这样：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># tomcat-docbase 前面的路径是 System.getProperty(java.io.tempdir)</span>
/private/var/folders/28/1tyh6prj3xg6xcdx_3qlkwr80000gn/T/tomcat-docbase.2007207725651733988.8080
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是如果在这里保存了文件，重启的时候就找不到其中的文件了，因为重启后生成的缓存文件夹不一样。</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmkod0qmltj30bu07ywer.jpg" alt=""></p> <p>当新建了 webapp 目录，jar 包启动的时候，他会指向 webapp 在主机上的路径，但是换了台主机，他依然会指向缓存文件夹</p> <h2 id="本文参考"><a href="#本文参考" class="header-anchor">#</a> 本文参考</h2> <p><a href="https://qinjiangbo.com/build-fat-jar-with-maven.html" target="_blank" rel="noopener noreferrer">使用 Maven 生成 Fat Jar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.cn/post/6844903892149518343" target="_blank" rel="noopener noreferrer">Spring-Boot 启动之前做了哪些事？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://incoder.org/2019/07/05/springboot2/" target="_blank" rel="noopener noreferrer">SpringBoot（二） 启动分析 JarLauncher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 图不错</p> <p><a href="https://fangjian0423.github.io/2017/05/31/springboot-executable-jar/" target="_blank" rel="noopener noreferrer">SpringBoot 源码分析之 SpringBoot 可执行文件解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 版本是 1.x 的</p> <p><a href="https://juejin.cn/post/6868536093000761357" target="_blank" rel="noopener noreferrer">终于搞懂了 SpringBoot 的 jar 包启动原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://blog.csdn.net/hzbooks/article/details/108688339" target="_blank" rel="noopener noreferrer">***SpringBoot 基于 jar 包启动核心原理及流程详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="content edit-link"><a href="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335/edit/master/docs/doc-backend/framework/Jar2.md" target="_blank" rel="noopener noreferrer">
      编辑此页面
    </a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="content page-nav"><p class="inner"><span class="prev"><a href="/doc-backend/framework/Jar.html" class="prev">&lt; Jar 包那些事</a></span> <span class="next"><a href="/doc-backend/framework/JavaClassLoader.html">
          浅析 Java 类加载器
          &gt;
        </a></span></p></div> <div class="footer">数据中心 研发二部</div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.16cdc938.js" defer></script><script src="/assets/js/3.4f14b16d.js" defer></script><script src="/assets/js/1.02cf7ae9.js" defer></script><script src="/assets/js/37.00738964.js" defer></script>
  </body>
</html>
