<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>单点登录 —— session共享 | Fellow Travellers</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/assets/img/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <meta name="description" content="Fellow-Travellers documents for tech3D / mobile / calc / back-end">
    <link rel="preload" href="/assets/css/0.styles.d4a3a82a.css" as="style"><link rel="preload" href="/assets/js/app.16cdc938.js" as="script"><link rel="preload" href="/assets/js/3.4f14b16d.js" as="script"><link rel="preload" href="/assets/js/1.02cf7ae9.js" as="script"><link rel="preload" href="/assets/js/43.8e4bef73.js" as="script"><link rel="prefetch" href="/assets/js/10.f5269c4e.js"><link rel="prefetch" href="/assets/js/100.c7e247ff.js"><link rel="prefetch" href="/assets/js/101.b60225bc.js"><link rel="prefetch" href="/assets/js/102.adacab9e.js"><link rel="prefetch" href="/assets/js/103.32cd0f3b.js"><link rel="prefetch" href="/assets/js/104.1fd9ea1d.js"><link rel="prefetch" href="/assets/js/105.5bfce959.js"><link rel="prefetch" href="/assets/js/106.44ca9c1d.js"><link rel="prefetch" href="/assets/js/107.9ee3fdbe.js"><link rel="prefetch" href="/assets/js/108.2e6ba386.js"><link rel="prefetch" href="/assets/js/109.12b4497c.js"><link rel="prefetch" href="/assets/js/11.9161989f.js"><link rel="prefetch" href="/assets/js/110.d255fdda.js"><link rel="prefetch" href="/assets/js/111.64c62930.js"><link rel="prefetch" href="/assets/js/112.6a427f04.js"><link rel="prefetch" href="/assets/js/113.5ec41ed5.js"><link rel="prefetch" href="/assets/js/114.d289af71.js"><link rel="prefetch" href="/assets/js/115.b052778b.js"><link rel="prefetch" href="/assets/js/116.f20d5acd.js"><link rel="prefetch" href="/assets/js/117.759b608c.js"><link rel="prefetch" href="/assets/js/118.a00460b4.js"><link rel="prefetch" href="/assets/js/119.021cbb12.js"><link rel="prefetch" href="/assets/js/12.e1aacb47.js"><link rel="prefetch" href="/assets/js/120.5bd8b71f.js"><link rel="prefetch" href="/assets/js/121.3e722ff2.js"><link rel="prefetch" href="/assets/js/122.a825e6c4.js"><link rel="prefetch" href="/assets/js/123.ff402ce6.js"><link rel="prefetch" href="/assets/js/124.287761b7.js"><link rel="prefetch" href="/assets/js/125.b4048370.js"><link rel="prefetch" href="/assets/js/126.bef086fd.js"><link rel="prefetch" href="/assets/js/127.a0784eab.js"><link rel="prefetch" href="/assets/js/128.66f3cbc1.js"><link rel="prefetch" href="/assets/js/129.aef33c57.js"><link rel="prefetch" href="/assets/js/13.faee7a70.js"><link rel="prefetch" href="/assets/js/130.0fbb1019.js"><link rel="prefetch" href="/assets/js/131.61f2146b.js"><link rel="prefetch" href="/assets/js/132.3d912bd8.js"><link rel="prefetch" href="/assets/js/133.b688ed34.js"><link rel="prefetch" href="/assets/js/134.59d26e48.js"><link rel="prefetch" href="/assets/js/135.2d1de6ca.js"><link rel="prefetch" href="/assets/js/136.82c509c1.js"><link rel="prefetch" href="/assets/js/137.aa6f5b18.js"><link rel="prefetch" href="/assets/js/138.8f50bb93.js"><link rel="prefetch" href="/assets/js/139.83f80acb.js"><link rel="prefetch" href="/assets/js/14.5e1b322f.js"><link rel="prefetch" href="/assets/js/140.255a8042.js"><link rel="prefetch" href="/assets/js/141.a7ad537d.js"><link rel="prefetch" href="/assets/js/142.b0c92d9c.js"><link rel="prefetch" href="/assets/js/143.f15b1f80.js"><link rel="prefetch" href="/assets/js/144.813a5a2e.js"><link rel="prefetch" href="/assets/js/145.b7069ddf.js"><link rel="prefetch" href="/assets/js/146.9fcc40e8.js"><link rel="prefetch" href="/assets/js/147.654c12e8.js"><link rel="prefetch" href="/assets/js/148.d2104b86.js"><link rel="prefetch" href="/assets/js/149.16115bff.js"><link rel="prefetch" href="/assets/js/15.c64a0296.js"><link rel="prefetch" href="/assets/js/150.e19d3aa4.js"><link rel="prefetch" href="/assets/js/151.e1e9732d.js"><link rel="prefetch" href="/assets/js/152.e4d9ed7c.js"><link rel="prefetch" href="/assets/js/153.720bddec.js"><link rel="prefetch" href="/assets/js/154.6d76f159.js"><link rel="prefetch" href="/assets/js/155.56639bb5.js"><link rel="prefetch" href="/assets/js/156.1b1456ad.js"><link rel="prefetch" href="/assets/js/157.41735b3f.js"><link rel="prefetch" href="/assets/js/158.2f7e2a71.js"><link rel="prefetch" href="/assets/js/159.8ecf5123.js"><link rel="prefetch" href="/assets/js/16.f13c1a4b.js"><link rel="prefetch" href="/assets/js/160.dd6f3d5e.js"><link rel="prefetch" href="/assets/js/161.ba4d9a7f.js"><link rel="prefetch" href="/assets/js/162.297aea0d.js"><link rel="prefetch" href="/assets/js/163.e34450b7.js"><link rel="prefetch" href="/assets/js/164.34381886.js"><link rel="prefetch" href="/assets/js/165.d4c2775d.js"><link rel="prefetch" href="/assets/js/166.c4c9cefb.js"><link rel="prefetch" href="/assets/js/167.d323a0a9.js"><link rel="prefetch" href="/assets/js/168.c20012b9.js"><link rel="prefetch" href="/assets/js/169.3cfddb83.js"><link rel="prefetch" href="/assets/js/17.e99ac461.js"><link rel="prefetch" href="/assets/js/170.3d3526f6.js"><link rel="prefetch" href="/assets/js/171.bba7cce9.js"><link rel="prefetch" href="/assets/js/172.8fbda3bd.js"><link rel="prefetch" href="/assets/js/173.1532f8d6.js"><link rel="prefetch" href="/assets/js/174.638e5e0a.js"><link rel="prefetch" href="/assets/js/175.d8d82e12.js"><link rel="prefetch" href="/assets/js/176.4b3a122c.js"><link rel="prefetch" href="/assets/js/177.3d9e6e89.js"><link rel="prefetch" href="/assets/js/178.58b1bf9b.js"><link rel="prefetch" href="/assets/js/179.3fc5f21a.js"><link rel="prefetch" href="/assets/js/18.2df0d7da.js"><link rel="prefetch" href="/assets/js/180.436cb2b1.js"><link rel="prefetch" href="/assets/js/181.dadcbdd8.js"><link rel="prefetch" href="/assets/js/182.d7f00bd5.js"><link rel="prefetch" href="/assets/js/183.b6a49ebe.js"><link rel="prefetch" href="/assets/js/184.72f1e1df.js"><link rel="prefetch" href="/assets/js/185.a30e0b04.js"><link rel="prefetch" href="/assets/js/186.a89aa666.js"><link rel="prefetch" href="/assets/js/187.c7601a79.js"><link rel="prefetch" href="/assets/js/188.47d25cdd.js"><link rel="prefetch" href="/assets/js/189.a5220877.js"><link rel="prefetch" href="/assets/js/19.74c2fe85.js"><link rel="prefetch" href="/assets/js/190.7fea63c8.js"><link rel="prefetch" href="/assets/js/191.79188b69.js"><link rel="prefetch" href="/assets/js/192.91858bc5.js"><link rel="prefetch" href="/assets/js/193.f8c9dc11.js"><link rel="prefetch" href="/assets/js/194.db5d514f.js"><link rel="prefetch" href="/assets/js/195.a21dfa21.js"><link rel="prefetch" href="/assets/js/196.3deca662.js"><link rel="prefetch" href="/assets/js/197.a26c6a57.js"><link rel="prefetch" href="/assets/js/198.199de2a9.js"><link rel="prefetch" href="/assets/js/199.3a93f5fd.js"><link rel="prefetch" href="/assets/js/20.37ef7b5a.js"><link rel="prefetch" href="/assets/js/200.2e0ca284.js"><link rel="prefetch" href="/assets/js/201.43159287.js"><link rel="prefetch" href="/assets/js/202.47ac18b9.js"><link rel="prefetch" href="/assets/js/21.8edf360c.js"><link rel="prefetch" href="/assets/js/22.681f9ff8.js"><link rel="prefetch" href="/assets/js/23.102f38f3.js"><link rel="prefetch" href="/assets/js/24.0d068097.js"><link rel="prefetch" href="/assets/js/25.b8c6fba0.js"><link rel="prefetch" href="/assets/js/26.b76fcccf.js"><link rel="prefetch" href="/assets/js/27.b95d8356.js"><link rel="prefetch" href="/assets/js/28.425d53a0.js"><link rel="prefetch" href="/assets/js/29.49ae4d56.js"><link rel="prefetch" href="/assets/js/30.268326de.js"><link rel="prefetch" href="/assets/js/31.d1322ccd.js"><link rel="prefetch" href="/assets/js/32.6baff7b9.js"><link rel="prefetch" href="/assets/js/33.91599495.js"><link rel="prefetch" href="/assets/js/34.7d1e8694.js"><link rel="prefetch" href="/assets/js/35.a28b2867.js"><link rel="prefetch" href="/assets/js/36.926c21b7.js"><link rel="prefetch" href="/assets/js/37.00738964.js"><link rel="prefetch" href="/assets/js/38.c07a024e.js"><link rel="prefetch" href="/assets/js/39.23ab4214.js"><link rel="prefetch" href="/assets/js/4.79366a86.js"><link rel="prefetch" href="/assets/js/40.47c89362.js"><link rel="prefetch" href="/assets/js/41.0e9b77b3.js"><link rel="prefetch" href="/assets/js/42.e93c36a9.js"><link rel="prefetch" href="/assets/js/44.f5808021.js"><link rel="prefetch" href="/assets/js/45.3afe2dae.js"><link rel="prefetch" href="/assets/js/46.f597a77f.js"><link rel="prefetch" href="/assets/js/47.11f2d487.js"><link rel="prefetch" href="/assets/js/48.7fef6ef8.js"><link rel="prefetch" href="/assets/js/49.b2d21efe.js"><link rel="prefetch" href="/assets/js/5.9ee91412.js"><link rel="prefetch" href="/assets/js/50.5832583c.js"><link rel="prefetch" href="/assets/js/51.54c00e7a.js"><link rel="prefetch" href="/assets/js/52.bd5535f0.js"><link rel="prefetch" href="/assets/js/53.0d38f84a.js"><link rel="prefetch" href="/assets/js/54.65144b95.js"><link rel="prefetch" href="/assets/js/55.368817a9.js"><link rel="prefetch" href="/assets/js/56.04e15523.js"><link rel="prefetch" href="/assets/js/57.b41a7dc6.js"><link rel="prefetch" href="/assets/js/58.0f0d92dd.js"><link rel="prefetch" href="/assets/js/59.e7dddc9e.js"><link rel="prefetch" href="/assets/js/6.b921ef33.js"><link rel="prefetch" href="/assets/js/60.4038bd0b.js"><link rel="prefetch" href="/assets/js/61.5d51e956.js"><link rel="prefetch" href="/assets/js/62.786b095c.js"><link rel="prefetch" href="/assets/js/63.9da19a49.js"><link rel="prefetch" href="/assets/js/64.48f50f07.js"><link rel="prefetch" href="/assets/js/65.0fd7ee4a.js"><link rel="prefetch" href="/assets/js/66.5d68a363.js"><link rel="prefetch" href="/assets/js/67.f4882da2.js"><link rel="prefetch" href="/assets/js/68.224daefc.js"><link rel="prefetch" href="/assets/js/69.420801b1.js"><link rel="prefetch" href="/assets/js/7.e128bbee.js"><link rel="prefetch" href="/assets/js/70.1e62f96f.js"><link rel="prefetch" href="/assets/js/71.62f9fa7c.js"><link rel="prefetch" href="/assets/js/72.ad20df74.js"><link rel="prefetch" href="/assets/js/73.e16fef7c.js"><link rel="prefetch" href="/assets/js/74.c1f72d12.js"><link rel="prefetch" href="/assets/js/75.e1f28980.js"><link rel="prefetch" href="/assets/js/76.2c304c87.js"><link rel="prefetch" href="/assets/js/77.7265d1f0.js"><link rel="prefetch" href="/assets/js/78.c7c2fdd3.js"><link rel="prefetch" href="/assets/js/79.0be55b5d.js"><link rel="prefetch" href="/assets/js/8.b17d0b27.js"><link rel="prefetch" href="/assets/js/80.3c460019.js"><link rel="prefetch" href="/assets/js/81.972b58cd.js"><link rel="prefetch" href="/assets/js/82.6c4d50e0.js"><link rel="prefetch" href="/assets/js/83.89ff3b39.js"><link rel="prefetch" href="/assets/js/84.5629cfb0.js"><link rel="prefetch" href="/assets/js/85.78a9bc3f.js"><link rel="prefetch" href="/assets/js/86.b429e7fb.js"><link rel="prefetch" href="/assets/js/87.5c3ba926.js"><link rel="prefetch" href="/assets/js/88.52737753.js"><link rel="prefetch" href="/assets/js/89.696bb63f.js"><link rel="prefetch" href="/assets/js/9.0874a43d.js"><link rel="prefetch" href="/assets/js/90.60296dbe.js"><link rel="prefetch" href="/assets/js/91.2d2fd4df.js"><link rel="prefetch" href="/assets/js/92.d860f080.js"><link rel="prefetch" href="/assets/js/93.b341ebd9.js"><link rel="prefetch" href="/assets/js/94.ebd37258.js"><link rel="prefetch" href="/assets/js/95.15dbfc06.js"><link rel="prefetch" href="/assets/js/96.041d049b.js"><link rel="prefetch" href="/assets/js/97.e22ed305.js"><link rel="prefetch" href="/assets/js/98.2e23ad42.js"><link rel="prefetch" href="/assets/js/99.e886cd85.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d4a3a82a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar shadow"><div class="con-btns-header"><a href="/" class="home-link router-link-active"><div class="con-logo"><!----> <span class="site-name">Fellow Travellers</span></div></a> <div class="links"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link" data-v-e7cf42d2>主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">三维</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-tech3d/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/language/Micro-frontend_Start.html" class="nav-link" data-v-e7cf42d2>开发语言</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/production/" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/codelab/Principle_of_Visualizatio_for_WebGL.html" class="nav-link" data-v-e7cf42d2>专题</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/other/SuperMap_Questions_and_Answer.html" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-frontend/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/base/EC_ScopChain_Closure.html" class="nav-link" data-v-e7cf42d2>开发基础</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/web-gis/" class="nav-link" data-v-e7cf42d2>WebGIS开发</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/solution/" class="nav-link" data-v-e7cf42d2>解决方案</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/best-practice/" class="nav-link" data-v-e7cf42d2>最佳实践</a></li><li class="dropdown-item"><!----> <a href="/doc-frontend/arithmetic/QuickSort.html" class="nav-link" data-v-e7cf42d2>算法</a></li><li class="dropdown-item"><!----> <a href="/doc-tech3d/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">移动</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-mobile/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/dataResource/sourceCodeLib.html" class="nav-link" data-v-e7cf42d2>数据资源</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/product/nativeApp.html" class="nav-link" data-v-e7cf42d2>产品分型</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/appStore/" class="nav-link" data-v-e7cf42d2>应用商店</a></li><li class="dropdown-item"><!----> <a href="/doc-mobile/other/designDocument.html" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-calc3d/start/XinShouShouCe.html" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/gis/Base_ZBX_ZongJie.html" class="nav-link" data-v-e7cf42d2>GIS</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/database/Oracle_LostSysPassword.html" class="nav-link" data-v-e7cf42d2>数据库</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/language/" class="nav-link" data-v-e7cf42d2>开发语言</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/codelab/" class="nav-link" data-v-e7cf42d2>源码库</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/production/DDP_ArcGIS_BuShuShouCe.html" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-calc3d/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后台</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-backend/start/" class="nav-link" data-v-e7cf42d2>入门手册</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/database/Mongoazyx.html" class="nav-link" data-v-e7cf42d2>数据库</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/framework/Git.html" class="nav-link" data-v-e7cf42d2>开发基础</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/production/" class="nav-link" data-v-e7cf42d2>产品</a></li><li class="dropdown-item"><!----> <a href="/doc-backend/other/" class="nav-link" data-v-e7cf42d2>其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础研发</span></a> <ul class="nav-dropdown"><li class="dropdown-item"><!----> <a href="/doc-base/dist-utils/API.html" class="nav-link" data-v-e7cf42d2>dist-utils</a></li><li class="dropdown-item"><!----> <a href="http://192.168.200.39:18088/EyeMapAPI/" target="_blank" rel="noopener noreferrer" class="nav-link" data-v-e7cf42d2>eyemap业务库</a></li><li class="dropdown-item"><!----> <a href="/doc-base/stylelint-config/" class="nav-link" data-v-e7cf42d2>stylelint-config</a></li></ul></div></div><div class="nav-item"><a href="/doc-share/SuperMap_Pipe3DStrategy.html" class="nav-link" data-v-e7cf42d2>分享</a></div><div class="nav-item"><a href="https://fellowtravellers.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link" data-v-e7cf42d2>社区</a></div><div class="nav-item"><a href="/doc-help/mdRule.html" class="nav-link" data-v-e7cf42d2>帮助</a></div></nav></div></div> <div class="con-redes-download"><a title="GitLab" href="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335/" target="_blank" rel="noopener noreferrer" class="repo-link flaticon-github"></a></div></header> <div class="sidebar-map"><div class="c-sidebar-map"><ul class="sidebar-links-map"><li><div class="sidebar-group first"><ul class="sidebar-group-items"><li><a href="/doc-backend/framework/Git.html" class="sidebar-link siderbar-map-item">GIT 使用介绍</a></li><li><a href="/doc-backend/framework/Jar.html" class="sidebar-link siderbar-map-item">Jar 包那些事</a></li><li><a href="/doc-backend/framework/Jar2.html" class="sidebar-link siderbar-map-item">Jar 包那些事 2</a></li><li><a href="/doc-backend/framework/JavaClassLoader.html" class="sidebar-link siderbar-map-item">浅析 Java 类加载器</a></li><li><a href="/doc-backend/framework/k8s.html" class="sidebar-link siderbar-map-item">k8s 简介</a></li><li><a href="/doc-backend/framework/Maven.html" class="sidebar-link siderbar-map-item">Maven 那点不为人知的事</a></li><li><a href="/doc-backend/framework/nginx-start.html" class="sidebar-link siderbar-map-item">nginx 简介</a></li><li><a href="/doc-backend/framework/session.html" aria-current="page" class="active sidebar-link siderbar-map-item">单点登录 —— session共享</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-backend/framework/session.html#session-共享入门" class="sidebar-link siderbar-map-item">session 共享入门</a></li></ul></li><li><a href="/doc-backend/framework/oauth2.html" class="sidebar-link siderbar-map-item">OAuth2 简介</a></li></ul></div></li></ul> </div></div> <div class="sidebar"><div class="c-sidebar"> <div class="search-box"><input aria-label="Search" placeholder="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>开发基础</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/doc-backend/framework/Git.html" class="sidebar-link">GIT 使用介绍</a></li><li><a href="/doc-backend/framework/Jar.html" class="sidebar-link">Jar 包那些事</a></li><li><a href="/doc-backend/framework/Jar2.html" class="sidebar-link">Jar 包那些事 2</a></li><li><a href="/doc-backend/framework/JavaClassLoader.html" class="sidebar-link">浅析 Java 类加载器</a></li><li><a href="/doc-backend/framework/k8s.html" class="sidebar-link">k8s 简介</a></li><li><a href="/doc-backend/framework/Maven.html" class="sidebar-link">Maven 那点不为人知的事</a></li><li><a href="/doc-backend/framework/nginx-start.html" class="sidebar-link">nginx 简介</a></li><li><a href="/doc-backend/framework/session.html" aria-current="page" class="active sidebar-link">单点登录 —— session共享</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-backend/framework/session.html#session-共享入门" class="sidebar-link">session 共享入门</a></li></ul></li><li><a href="/doc-backend/framework/oauth2.html" class="sidebar-link">OAuth2 简介</a></li></ul></div></li></ul> </div></div> <!----> <!----> <div class="page"><div class="content-pagex content content__default"><h2 id="session-共享入门"><a href="#session-共享入门" class="header-anchor">#</a> session 共享入门</h2> <h3 id="大纲"><a href="#大纲" class="header-anchor">#</a> 大纲</h3> <ol><li><p>分享背景
1.1 cookie/session 机制</p> <p>1.2 tomcat 对 session 的管理</p></li> <li><p>为什么要 session 共享</p></li> <li><p>常用的方案</p> <p>3.1 session sticky</p> <p>3.2 组播方式
3.3 spring-session
3.4 jwt
3.5 Servlet 容器提供的插件</p></li> <li><p>方案的选择</p></li> <li><p>代码示例</p></li></ol> <h3 id="_1-分享背景"><a href="#_1-分享背景" class="header-anchor">#</a> 1. 分享背景</h3> <h4 id="cookie-session-机制"><a href="#cookie-session-机制" class="header-anchor">#</a> cookie/session 机制</h4> <p>Cookie 和 Session 是为了在无状态的 HTTP 协议之上维护会话状态， 因为 HTTP 协议是无状态的，即每次用户请求到达服务器时，HTTP 服务器并不知道这个用户是谁、是否登录过等。现在的服务器之所以知道我们是否已经登录，是因为服务器在登录时设置了浏览器的 Cookie！Session 则是借由 Cookie 而实现的更高层的服务器与浏览器之间的会话。</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/bee97bf0b2c253eb226e5cc0a3411001/cookie.png" alt=""></p> <p>Cookie 是由客户端保存的小型文本文件，其内容为一系列的键值对。 Cookie 是由 HTTP 服务器设置的，保存在浏览器中， 由于 cookie 保存在了客户端，就存在了一些安全隐患，比如被篡改等问题。早期通过服务器为每个 Cookie 项生成签名，由于用户篡改 Cookie 后无法生成对应的签名， 服务器便可以得知用户对 Cookie 进行了篡改 ，又因为 cookie 是明文传输，只要服务器设置过一次签名， 以后就可以用这个签名来欺骗服务器了 ，进而出现了 session 机制。Session 是存储在服务器端的，避免了在客户端 Cookie 中存储敏感数据。 Session 可以存储在 HTTP 服务器的内存中，也可以存在内存数据库（如 redis）中， 对于重量级的应用甚至可以存储在数据库中。</p> <h4 id="tomcat-对-session-的管理"><a href="#tomcat-对-session-的管理" class="header-anchor">#</a> tomcat 对 session 的管理</h4> <p>Session 管理是 JavaEE 容器比较重要的一部分 ，在 Tomcat 中主要由每个 context 容器内的一个 Manager 对象来管理 session。对于这个 manager 对象的实现，可以根据 tomcat 提供的接口或基类来自己定制，同时，tomcat 也提供了标准实现。在每个 context 对象，即 web app 都具有一个独立的 manager 对象。通过 server.xml 可以配置定制化的 manager，也可以不配置。不管怎样，在生成 context 对象时，都会生成一个 manager 对象。缺省的是 StandardManager 类，在 Tomcat 中，Session 是保存到一个 ConcurrentHashMap 中的 。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Minimal implementation of the &lt;b&gt;Manager&lt;/b&gt; interface that supports
* no session persistence or distributable capabilities. This class may
* be subclassed to create more sophisticated Manager implementations.
*
* @author Craig R. McClanahan
*/</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ManagerBase</span> <span class="token keyword">extends</span> <span class="token class-name">LifecycleMBeanBase</span> <span class="token keyword">implements</span> <span class="token class-name">Manager</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
    * The set of currently active Sessions for this Manager, keyed by
    * session identifier.
    */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>若是实现 Session 自定义化，可以实现标准 servlet 的 session 接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token class-name">HttpSession</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Tomcat 也提供了标准的 session 实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token class-name">StandardSession</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Standard implementation of the &lt;b&gt;Session&lt;/b&gt; interface. This object is
* serializable, so that it can be stored in persistent storage or transferred
* to a different JVM for distributable session support.
* &lt;p&gt;
* &lt;b&gt;IMPLEMENTATION NOTE&lt;/b&gt;: An instance of this class represents both the
* internal (Session) and application level (HttpSession) view of the session.
* However, because the class itself is not declared public, Java logic outside
* of the &lt;code&gt;org.apache.catalina.session&lt;/code&gt; package cannot cast an
* HttpSession view of this instance back to a Session view.
* &lt;p&gt;
* &lt;b&gt;IMPLEMENTATION NOTE&lt;/b&gt;: If you add fields to this class, you must
* make sure that you carry them over in the read/writeObject methods so
* that this class is properly serialized.
*
* @author Craig R. McClanahan
* @author Sean Legassick
* @author &lt;a href=&quot;mailto:jon@latchkey.com&quot;&gt;Jon S. Stevens&lt;/a&gt;
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StandardSession</span> <span class="token keyword">implements</span> <span class="token class-name">HttpSession</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
    * Construct a new Session associated with the specified Manager.
    *
    * @param manager The manager with which this Session is associated
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">StandardSession</span><span class="token punctuation">(</span><span class="token class-name">Manager</span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token operator">=</span> manager<span class="token punctuation">;</span>
        <span class="token comment">// Initialize access count</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTIVITY_CHECK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            accessCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_2-为什么要-session-共享"><a href="#_2-为什么要-session-共享" class="header-anchor">#</a> 2. 为什么要 session 共享</h3> <p>为了使 web 能适应大规模的访问，需要实现应用的集群部署。集群最有效的方案就是负载均衡，而实现负载均衡用户每一个请求都有可能被分配到不固定的服务器上，就出现了 session 一致性问题。比如 Nginx 使用轮询方式，用户第一次请求，请求被分配到到了 A web 服务器，用户在 A web 服务器上进行登录，并保存登录信息（Session 信息），并将 Session 信息响应给浏览器。当用户第二次在请求的时候 通过轮询会定位到 B web 服务器，此时 B web 服务器上没有 用户的登录信息（Session 信息），则会提示用户进行登录。</p> <h3 id="_3-常用-session-共享思路"><a href="#_3-常用-session-共享思路" class="header-anchor">#</a> 3. 常用 session 共享思路</h3> <h4 id="session-sticky"><a href="#session-sticky" class="header-anchor">#</a> session sticky</h4> <p>当服务端的一个特定路径会被同一个用户连续访问时，如果负载均衡策略还是轮询的话，那该用户的多次访问会被打到各台服务器上，这显然并不高效。甚至考虑一种极端情况，用户需要分片上传文件到服务器下，然后再由服务器将分片合并，这时如果用户的请求到达了不同的服务器，那么分片将存储于不同的服务器目录中，导致无法将分片合并。所以，此类场景可以考虑采用 nginx 提供的 ip_hash 策略。既能满足每个用户请求到同一台服务器，又能满足不同用户之间负载均衡。 一般来讲，要用到 url_hash，是要配合缓存命中来使用。如有一个服务器集群 A，需要对外提供文件下载，由于文件上传量巨大，没法存储到服务器磁盘中，所以用到了第三方云存储来做文件存储。服务器集群 A 收到客户端请求之后，需要从云存储中下载文件然后返回，为了省去不必要的网络带宽和下载耗时，在服务器集群 A 上做了一层临时缓存（缓存一个月）。由于是服务器集群，所以同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。在此类场景下，为了使得缓存命中率提高，很适合使用 url_hash 策略，同一个 url（也就是同一个资源请求）会到达同一台机器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取，既减少了带宽，也减少的下载时间 。</p> <h4 id="组播方式"><a href="#组播方式" class="header-anchor">#</a> 组播方式</h4> <p>传统的 IP 通信有两种方式：一种是在源主机与目的主机之间点对点的通信，即单播；另一种是在源主机与同一网段中所有其它主机之间点对多点的通信，即广播。如果要将信息发送给多个主机而非所有主机，若采用广播方式实现，不仅会将信息发送给不需要的主机而浪费带宽，也不能实现跨网段发送；若采用单播方式实现，重复的 IP 包不仅会占用大量带宽，也会增加源主机的负载。所以，传统的单播和广播通信方式不能有效地解决单点发送、多点接收的问题。</p> <p>组播是指在 IP 网络中将数据包以尽力传送的形式发送到某个确定的节点集合（即组播组），其基本思想是：源主机（即组播源）只发送一份数据，其目的地址为组播组地址；组播组中的所有接收者都可收到同样的数据拷贝，并且只有组播组内的主机可以接收该数据，而其它主机则不能收到。</p> <h4 id="spring-session"><a href="#spring-session" class="header-anchor">#</a> spring-session</h4> <p>此处不深入剖析 Spring Session 的结构，主要是一起来看看 Spring 是如何接管 Session 的 。</p> <h5 id="spring-session-基于-xml-的配置"><a href="#spring-session-基于-xml-的配置" class="header-anchor">#</a> Spring Session 基于 XML 的配置</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>## spring 配置文件
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redisHttpSessionConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxInactiveIntervalInSeconds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1800<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

## web.xml配置
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="核心类解析"><a href="#核心类解析" class="header-anchor">#</a> 核心类解析</h5> <p>DelegatingFilterProxy 解析</p> <p>DelegatingFilterProxy 是一个 Filter 的代理类，DelegatingFilterProxy 继承自 GenericFilterBean。GenericFilterBean 是一个抽象类，分别实现了 Filter, BeanNameAware, EnvironmentAware, ServletContextAware, InitializingBean, DisposableBean 接口，继承关系如下图：</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/3af2c57488b5da8ec2853b4350877692/DelegatingFilterProxy%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt=""></p> <p>对于 Filter 来说，最重要肯定就是初始化（init）和 doFilter 方法了，初始化方法在父类 GenericFilterBean 中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Standard way of initializing this filter.
* Map config parameters onto bean properties of this filter, and
* invoke subclass initialization.
* @param filterConfig the configuration for this filter
* @throws ServletException if bean properties are invalid (or required
* properties are missing), or if subclass initialization fails.
* @see #initFilterBean
*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//省略部分代码</span>
    <span class="token comment">// Let subclasses do whatever initialization they like.</span>
    <span class="token function">initFilterBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//注意这里,initFilterBean在子类中实现</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Filter '&quot;</span> <span class="token operator">+</span> filterConfig<span class="token punctuation">.</span><span class="token function">getFilterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;' configured successfully&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>initFilterBean 在子类中实现，也就是说当 DelegatingFilterProxy 在执行 Filter 的 init 方法时，会调用 initFilterBean 方法，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initFilterBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// delegate 为实际的Filter</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If no target bean name specified, use filter name.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//这里的targetBeanName 便是我们web.xml 中配置的springSessionRepositoryFilter</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName <span class="token operator">=</span> <span class="token function">getFilterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Fetch Spring root application context and initialize the delegate early,</span>
            <span class="token comment">// if possible. If the root application context will be started after this</span>
            <span class="token comment">// filter proxy, we'll have to resort to lazy initialization.</span>
            <span class="token class-name">WebApplicationContext</span> wac <span class="token operator">=</span> <span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wac <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//初始化Filter</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span>wac<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>delegate 为真正的 Filter,通过 web.xml 中配置的 Filter 名字（即:springSessionRepositoryFilter）来获取这个 Filter，我们继续往下看 initDelegate 这个方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span> wac<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Filter</span> delegate <span class="token operator">=</span> wac<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTargetFilterLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        delegate<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">getFilterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过上下文，获取到这个 Filter Bean,然后初始化这个 Filter。但是我们似乎没有手动配置这个 Bean，那么这个切入点就是我们开始在 spring 配置文件中声明的 RedisHttpSessionConfiguration 这个 bean 了 。</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/e35fe8050d1f40e7852f47e8606fdefa/RedisHttpSessionConfiguration%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="">
SessionRepositoryFilter 解析</p> <p>Spring Session 对 HTTP 的支持所依靠的是一个简单老式的 Servlet Filter，借助 servlet 规范中标准的特性来实现 Spring Session 的功能。Spring Session 在 RedisHttpSessionConfiguration 以及它的父类 SpringHttpSessionConfiguration 中 自动生成了许多 Bean，这里列举 springSessionRepositoryFilter 这个 Bean,而这个 Bean 是 SessionRepositoryFilter 类型的。SessionRepositoryFilter 继承自 OncePerRequestFilter，也是一个标准的 Servlet Filter。真正的核心在于它对请求的 HttpServletRequest ，HttpServletResponse 对进行包装了之后，然后调用 filterChain.doFilter(strategyRequest, strategyResponse); 往后传递，后面调用者通过 HttpServletRequest.getSession();获得 session 的话，得到的将会是 Spring Session 提供的 HttpServletSession 实例。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SessionRepositoryFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionRepositoryFilter</span><span class="token punctuation">(</span><span class="token class-name">SessionRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//传入 sessionRepository</span>
    <span class="token class-name">SessionRepositoryFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepositoryFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">(</span>sessionRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepositoryFilter<span class="token punctuation">.</span><span class="token function">setServletContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepositoryFilter<span class="token punctuation">.</span><span class="token function">setHttpSessionIdResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionIdResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sessionRepositoryFilter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>RedisOperationsSessionRepository 解析</p> <p>现在我们知道，DelegatingFilterProxy 中真正的 Filter 是 SessionRepositoryFilter，在生成 SessionRepositoryFilter 是传入了 sessionRepository，通过名字我们大概知道，这个应该是具体操作 session 的类，而这个类又具体是什么呢？，看下面的代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisOperationsSessionRepository</span> <span class="token function">sessionRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 操作redis的redisTemplate</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisOperationsSessionRepository</span> sessionRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisOperationsSessionRepository</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepository<span class="token punctuation">.</span><span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRedisSerializer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sessionRepository<span class="token punctuation">.</span><span class="token function">setDefaultSerializer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment">// maxInactiveIntervalInSeconds设置过期时间</span>
  sessionRepository<span class="token punctuation">.</span><span class="token function">setDefaultMaxInactiveInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxInactiveIntervalInSeconds<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisNamespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sessionRepository<span class="token punctuation">.</span><span class="token function">setRedisKeyNamespace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sessionRepository<span class="token punctuation">.</span><span class="token function">setRedisFlushMode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisFlushMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sessionRepository<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>到这里我们知道，这个 sessionRepository 具体就是：RedisOperationsSessionRepository ，这个类就是实际通过 redis 操作 session 的类 。</p> <p>好了，现在回到 DelegatingFilterProxy -&gt; initFilterBean 方法，具体的 Filter 已经找到了，这个 Filter 就是 SessionRepositoryFilter，那么这个 Filter 又是在什么时候生效的呢?,接下来我们看 DelegatingFilterProxy 的 doFilter 方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Filter</span> delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">WebApplicationContext</span> wac <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>wac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No WebApplicationContext found: no ContextLoaderListener or DispatcherServlet registered?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initDelegate</span><span class="token punctuation">(</span>wac<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegateToUse<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invokeDelegate</span><span class="token punctuation">(</span>delegateToUse<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//注意</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>注意 invokeDelegate 方法，进去看看：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeDelegate</span><span class="token punctuation">(</span><span class="token class-name">Filter</span> delegate<span class="token punctuation">,</span> <span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//调用 delegate的 doFilter 方法</span>
    delegate<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里我们大概知道了，DelegatingFilterProxy 实际上是委托给 delegate 的，而这里的 delegate 是 SessionRepositoryFilter，现在我们又回到 SessionRepositoryFilter 看看：</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/203594b1284feb82540774a78c8d10e6/SessionRepositoryFilter%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt=""></p> <p>SessionRepositoryFilter 没有重写 doFilter 方法，因此查看父类：OncePerRequestFilter，通过名字我们知道，这个 Filter 只执行一次.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">OncePerRequestFilter</span> <span class="token operator">-&gt;</span> doFilter<span class="token operator">:</span>
<span class="token comment">/**
* This {@code doFilter} implementation stores a request attribute for
* &quot;already filtered&quot;, proceeding without filtering again if the attribute is already * there.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>response <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span> <span class="token string">&quot;OncePerRequestFilter just supports HTTP requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">HttpServletRequest</span> httpRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> httpResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span> <span class="token comment">//查看是否已经过滤了</span>
    <span class="token keyword">boolean</span> hasAlreadyFilteredAttribute <span class="token operator">=</span> request
        <span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alreadyFilteredAttributeName<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasAlreadyFilteredAttribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Proceed without invoking this filter...</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Do invoke this filter...</span>
        <span class="token comment">//加入已经过滤标志</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alreadyFilteredAttributeName<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//调用 doFilterInternal</span>
            <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>httpRequest<span class="token punctuation">,</span> httpResponse<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Remove the &quot;already filtered&quot; request attribute for this request.</span>
            request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alreadyFilteredAttributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在该方法中，会检查该请求是否已经被过滤了，如果过滤过了那么执行下一个 Filter，否则放入已过滤标识，然后执行 Filter 功能，doFilterInternal 在 SessionRepositoryFilter 被重写 。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SessionRepositoryFilter</span> <span class="token operator">-&gt;</span> doFilterInternal<span class="token operator">:</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>SESSION_REPOSITORY_ATTR<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SessionRepositoryRequestWrapper</span> wrappedRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryRequestWrapper</span><span class="token punctuation">(</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SessionRepositoryResponseWrapper</span> wrappedResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryResponseWrapper</span><span class="token punctuation">(</span> wrappedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//包装 request,response</span>
    <span class="token class-name">HttpServletRequest</span> strategyRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionStrategy <span class="token punctuation">.</span><span class="token function">wrapRequest</span><span class="token punctuation">(</span>wrappedRequest<span class="token punctuation">,</span> wrappedResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> strategyResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionStrategy <span class="token punctuation">.</span><span class="token function">wrapResponse</span><span class="token punctuation">(</span>wrappedRequest<span class="token punctuation">,</span> wrappedResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>strategyRequest<span class="token punctuation">,</span> strategyResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//更新session</span>
        wrappedRequest<span class="token punctuation">.</span><span class="token function">commitSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Spring 接管 Tomcat 的 session 主要在这里可以看出来，Spring 会包装 HttpServletRequest ，HttpServletResponse ，当执行了这个 Filter 后，将包装了 request,response 专递到后面，这样后面所使用的都是 spring 包装过的，这样在获取 session 的接口，就被 spring 所控制了，当由服务器返回给用户是，调用 commitSession,更新 session。其中，SessionRepositoryRequestWrapper 和 SessionRepositoryResponseWrapper 是 SessionRepositoryFilter 中的 内部类。</p> <p>可以在 Controller 中进行 debug 看看我们拿到的 HttpServletRequest 和 HttpSession 到底是什么？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/query&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">15L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/93179623fbcf00d7292c2215aeb35ae6/ideadebug%E5%9B%BE.png" alt=""></p> <p>具接下来我们看一下 SessionRepositoryRequestWrapper 中关于 getSession()实现 ：</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/807717fea0f39509d1e79405895b8444/SessionRepositoryRequestWrapper%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt=""></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//通过sessionRepository 获取session,在redis 中 这里的 sessionRepository 是RedisOperationsSessionRepository</span>
    <span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository <span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    session<span class="token punctuation">.</span><span class="token function">setLastAccessedTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> session<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 重写 父类 getSession 方法</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">HttpSessionWrapper</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpSessionWrapper</span> currentSession <span class="token operator">=</span> <span class="token function">getCurrentSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//从当前请求获取sessionId</span>
    <span class="token class-name">String</span> requestedSessionId <span class="token operator">=</span> <span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestedSessionId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span>INVALID_SESSION_ID_ATTR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token function">getSession</span><span class="token punctuation">(</span>requestedSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionIdValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//对Spring session 进行包装(包装成HttpSession)</span>
            currentSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentSession<span class="token punctuation">.</span><span class="token function">setNew</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setCurrentSession</span><span class="token punctuation">(</span>currentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// This is an invalid session id. No need to ask again if</span>
            <span class="token comment">// request.getSession is invoked for the duration of this request</span>
            <span class="token function">setAttribute</span><span class="token punctuation">(</span>INVALID_SESSION_ID_ATTR<span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session<span class="token punctuation">.</span><span class="token function">setLastAccessedTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对Spring session 进行包装(包装成HttpSession)</span>
    currentSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCurrentSession</span><span class="token punctuation">(</span>currentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>到这里应该就很清楚了，spring 对 HttpServletRequest 进行包装，然后重写对 Session 操作的接口，内部调用 SessionRepository 的实现类来对 session 进行操作，到此大致讲述了 Spring Session 是如何控制 session 的了</p> <h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <p>当我们配置 DelegatingFilterProxy 时，会配置 filter-name:springSessionRepositoryFilter,当我们配置 RedisHttpSessionConfiguration 这个 bean 时，这个 Filter 则由 Spring 生成，而这个 Filter 实际是 ：SessionRepositoryFilter， 当有请求到达时，DelegatingFilterProxy 委托给 SessionRepositoryFilter，而它又将 HttpServletRequest,HttpServletResponse 进行一定的包装，重写对 session 操作的接口，然后将包装好的 request,response 传递到后续的 Filter 中，完成了对 Session 的拦截操作，后续应用操作的 Session 都是 Spring Session 包装后的 Session。</p> <p>注意：1.spring bean 的这个配置文件一定要写在 web.xml 的 context-param 部分。</p> <p>2.filter 的名字必须是 springSessionRepositoryFilter</p> <h4 id="jwt-json-web-tokens"><a href="#jwt-json-web-tokens" class="header-anchor">#</a> jwt(JSON Web Tokens )</h4> <p>一般情况下，web 项目都是通过 session 进行认证，每次请求数据时，都会把 jsessionid 放在 cookie 中，以便与服务端保持会话。</p> <p>前后端分离项目中，也可以通过 token 进行认证（登录时，生成唯一的 token 凭证），每次请求数据时，都会把 token 放在 header 中，服务端解析 token，并确定用户身份及用户权限，数据通过 json 交互。但是 token 一般都是 UUID 生成的一个随机码，作为一个 key 使用，从类似 redis 等缓存中获取具体的用户信息。所以一般需要一个存储介质来保存 token 和用户信息。在一些场景中，如单点登录时候有点麻烦。</p> <p>有没一种更方便的方式呢？答案是有的，就是我们今天要讲的 jwt。</p> <p>Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于 JSON 的开放标准。JWT 的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息。jwt 也算是一个特殊的 token，不过 jwt 中自带了用户的相关信息，所以不需要存储介质，只需要验证签名保证安全的前提下就可以直接获取到用户的相关信息。jwt 被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。</p> <p>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户 ，以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名。服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</p> <p>JWT 的三个部分依次如下。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Header（头部）
Payload（负载）
Signature（签名）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>下面依次介绍这三个部分</p> <p>头部 (Header)
Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>alg 属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；typ 属性表示这个令牌（tokenPayload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了 7 个官方字段，供选用 ）的类型（type），JWT 令牌统一写为 JWT。最后，将上面的 JSON 对象使用 Base64URL 算法转成字符串。</p> <p>载荷 （Payload）</p> <p>这里是承载消息具体内容的地方 。内容又可以分为 3 中标准。</p> <ul><li><p>标准中注册的声明</p></li> <li><p>公共的声明</p></li> <li><p>私有的声明</p></li></ul> <p>payload-标准中注册的声明 (建议但不强制使用) ：</p> <ul><li><p>iss: jwt 签发者</p></li> <li><p>sub: jwt 所面向的用户</p></li> <li><p>aud: 接收 jwt 的一方</p></li> <li><p>exp: jwt 的过期时间，这个过期时间必须要大于签发时间</p></li> <li><p>nbf: 定义在什么时间之前，该 jwt 都是不可用的.</p></li> <li><p>iat: jwt 的签发时间</p></li> <li><p>jti: jwt 的唯一身份标识，主要用来作为一次性 token,从而回避重放攻击。</p></li></ul> <p>payload-公共的声明 ：</p> <p>公共的声明可以添加任何的信息。一般这里我们会存放一下用户的基本信息（非敏感信息）。</p> <p>payload-私有的声明 ：</p> <p>私有声明是提供者和消费者所共同定义的声明。</p> <p>需要注意的是，不要存放敏感信息，不要存放敏感信息，不要存放敏感信息</p> <p>签证 （Signature）</p> <p>Signature 部分是对前两部分的签名，防止数据篡改</p> <p>首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>HMACSHA256(
	base64UrlEncode(header) + &quot;.&quot; +
	base64UrlEncode(payload),
	secret)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用&quot;点&quot;（<code>.</code>）分隔，就可以返回给用户</p> <p>JWT 的使用方式</p> <p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p> <p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Authorization: Bearer &lt;token&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面</p> <p>jwt 的特点</p> <p>（1）简洁，jwt 可以通过 URL，POST 参数或者在 HTTP header 发送，因为数据量小，传输速度也很快</p> <p>（2）自包含，jwt 负载中包含了所有用户所需要的信息，避免了多次查询数据库或缓存</p> <p>(3) JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</p> <p>（4）JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</p> <p>（5）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</p> <p>（6）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</p> <p>（7）为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</p> <h4 id="servlet-容器提供的插件"><a href="#servlet-容器提供的插件" class="header-anchor">#</a> Servlet 容器提供的插件</h4> <p>实现 Session 共享的方案很多，其中一种常用的就是使用 Tomcat、Jetty 等容器提供的 Session 共享功能，将 Session 的内容统一存储在一个数据库（如 MySQL）或缓存（如 Redis）中 。它的主要思想是利用 Servlet 容器提供的插件功能，自定义 HttpSession 的创建和管理策略，并通过配置的方式替换掉默认的策略。</p> <p>其中 tomcat-redis-session-manager 插件重写了 Tomcat 的 org.apache.catalina.session.ManagerBase 里边的具体写的操作， 将 tomcat 的 session 存储位置指向了 Redis：</p> <p><img src="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335//fellow-travellers/picgorepo/uploads/a7876155aaa201192d3bfce2d8b705d4/tomcat%E6%8F%92%E4%BB%B6%E5%BC%8F.png" alt=""></p> <p>RedisSessionManager 继承了 org.apache.catalina.session.ManagerBase 并重写了 add、findSession、createEmptySession、remove 等方法，并将对 session 的增删改查操作指向了对 Redis 数据存储的操作。</p> <h3 id="_4-方案的选择"><a href="#_4-方案的选择" class="header-anchor">#</a> 4. 方案的选择</h3> <p>session sticky 实际等同于单点部署，优点是可以不依赖 LVS 或者 nginx 等中间件，也不会出现 session 同步过程中的网络消耗，但是如果宕机，则会导致 session 丢失，而且对于扩展和删除集群中的节点，也会导致部分会话丢失。</p> <p>通过组播同步 session，可以不依赖 redis 这样的第三方组件，但是会造成网络流量瓶颈。</p> <p>Spring Session 不依赖于 Servlet 容器，而是 Web 应用代码层面的实现，直接在已有项目基础上加入 spring Session 框架来实现 Session 统一存储在 Redis 中。如果 Web 应用是基于 Spring 框架开发的，只需要对现有项目进行少量配置，即可将一个单机版的 Web 应用改为一个分布式应用，由于不基于 Servlet 容器，所以可以随意将项目移植到其他容器。但是 Spring Session 实现分布式 Session 共享有个缺陷, 无法实现跨域名共享 session , 只能在单台服务器上共享 session,这是因为是依赖 cookie 机制,而 cookie 无法跨域 。所以 spring Session 一般是用于多台服务器负载均衡时共享 Session 的，都是同一个域名，不会跨域。</p> <p>在 Web 应用中，绝大多数情况下，传统的 cookie-session 机制工作得更好。JWT 适合一次性的命令认证，颁发一个有效期极短的 JWT，即使暴露了危险也很小，由于每次操作都会生成新的 JWT，因此也没必要保存 JWT，真正实现无状态。</p> <p>使用 tomcat-redis-session-manager 对外透明 ，可以在不修改代码的前提下实现。但是配置相对还是有一点繁琐的，需要人为的去修改 Tomcat 的配置， 需要耦合 Tomcat 等 Servlet 容器的代码，必须在同一种中间件之间完成(如:tomcat-tomcat 之间)，session 复制带来的性能损失会快速增加.特别是当 session 中保存了较大的对象,而且对象变化较快时, 性能下降更加显著，会消耗系统性能，这种特性使得 web 应用的水平扩展受到了限制 。根据官方文档显示，目前对 tomcat6/7 支持，对 tomcat8 支持不友好。</p> <h3 id="_5-代码示例"><a href="#_5-代码示例" class="header-anchor">#</a> 5. 代码示例</h3> <h4 id="spring-session-2"><a href="#spring-session-2" class="header-anchor">#</a> spring session</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>web.xml配置
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code>spring-redis.xml配置
<span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>cache</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/cache<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>util</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/util<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd http://www.alibaba.com/schema/stat http://www.alibaba.com/schema/stat.xsd http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--spring-session+redis--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redisHttpSessionConfiguration<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--session过期时间，单位秒--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxInactiveIntervalInSeconds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.session.timeout}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jedisPoolConfig<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redis.clients.jedis.JedisPoolConfig<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxTotal<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.maxTotal}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxIdle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.maxIdle}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxWaitMillis<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.maxWait}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>testOnBorrow<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.testOnBorrow}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jedisConnectionFactory<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.data.redis.connection.jedis.JedisConnectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>destroy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hostName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.hostname}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>port<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.port}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>timeout<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.timeout}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>usePool<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>${redis.usePool}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>poolConfig<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jedisPoolConfig<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redisTemplate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.data.redis.core.RedisTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>connectionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jedisConnectionFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultSerializer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>keySerializer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.data.redis.serializer.StringRedisSerializer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hashKeySerializer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.data.redis.serializer.StringRedisSerializer<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redisUtil<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.dist.util.RedisUtil<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redisTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 让Spring Session不再执行config命令 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>constant</span>
            <span class="token attr-name">static-field</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.session.data.redis.config.ConfigureRedisAction.NO_OP<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code>pom.xml配置
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="组播方式-2"><a href="#组播方式-2" class="header-anchor">#</a> 组播方式</h4> <p>tomcat 之间通过配置 cluster + web.xml 配置实现 session 复制功能</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Cluster</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.tcp.SimpleTcpCluster<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">channelSendOptions</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.session.DeltaManager<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name">expireSessionsOnShutdown</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name">notifyListenersOnReplication</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Channel</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.group.GroupChannel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Membership</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.membership.McastService<span class="token punctuation">&quot;</span></span>
                        <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>228.0.0.4<span class="token punctuation">&quot;</span></span>
                        <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>45564<span class="token punctuation">&quot;</span></span>
                        <span class="token attr-name">frequency</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>500<span class="token punctuation">&quot;</span></span>
                        <span class="token attr-name">dropTime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>3000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Receiver</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.transport.nio.NioReceiver<span class="token punctuation">&quot;</span></span>
                      <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10.0.125.15<span class="token punctuation">&quot;</span></span>
                      <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>4001<span class="token punctuation">&quot;</span></span>
                      <span class="token attr-name">autoBind</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span>
                      <span class="token attr-name">selectorTimeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span>
                      <span class="token attr-name">maxThreads</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Sender</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.transport.ReplicationTransmitter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Transport</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.transport.nio.PooledParallelSender<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Sender</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Interceptor</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.group.interceptors.TcpFailureDetector<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Interceptor</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Channel</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.tcp.ReplicationValve<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">filter</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.session.JvmRouteBinderValve<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClusterListener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClusterListener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.catalina.ha.session.ClusterSessionListener<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Cluster</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>Manager 用来在节点间拷贝 Session，默认使用 DeltaManager，DeltaManager 采用的一种 all-to-all 的工作方式，即集群中的节点会把 Session 数据向所有其他节点拷贝，而不管其他节点是否部署了当前应用。当集群中的节点数量很多并且部署着不同应用时，可以使用 BackupManager，BackManager 仅向部署了当前应用的节点拷贝 Session。但是到目前为止 BackupManager 并未经过大规模测试，可靠性不及 DeltaManager。</p> <p>Membership 用于发现集群中的其他节点，这里的 address 用的是组播地址使用同一个组播地址和端口的多个节点同属一个子集群，因此通过自定义组播地址和端口就可将一个大的 tomcat 集群分成多个子集群。</p> <p>receiver 用于各个节点接收其他节点发送的数据，在默认配置下 tomcat 会从 4000-4100 间依次选取一个可用的端口进行接收，自定义配置时，如果多个 tomcat 节点在一台物理服务器上注意要使用不同的端口。</p> <p>Sender 用于向其他节点发送数据，具体实现通过 Transport 配置。</p> <p>Channel 是一个抽象的端口，和 socket 类似，集群 member 通过它收发信息。</p> <p>Valve 用于在节点向客户端响应前进行检测或进行某些操作，ReplicationValve 就是用于检测当前的响应是否涉及 Session 数据的更新，如果是则启动 Session 拷贝操作，filter 用于过滤请求，如客户端对图片，css，js 的请求就不会涉及 Session，因此不需检测，默认状态下不进行过滤，监测所有的响应。</p> <p>修改 web.xml ，即只在<web-app> 和</web-app>之间添加 <distributable></distributable></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://java.sun.com/xml/ns/javaee<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://java.sun.com/xml/ns/javaee
                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>3.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">metadata-complete</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">&gt;</span></span>gxtz-server-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>distributable</span><span class="token punctuation">/&gt;</span></span>

    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="tomcat-redis-session-manager-使用"><a href="#tomcat-redis-session-manager-使用" class="header-anchor">#</a> tomcat-redis-session-manager 使用</h4> <p>开源项目地址：<a href="https://github.com/jcoleman/tomcat-redis-session-manager" target="_blank" rel="noopener noreferrer">https://github.com/jcoleman/tomcat-redis-session-manager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>下载代码之后需要进行重新编译，生成所需要的 jar 。然后将编译生产<strong>tomcat-redis-session-1.0-SNAPSHOT.jar</strong>以及<strong>jedis-2.7.2.jar、commons-pool2-2.0.jar</strong> 三个 jar 包放在各个 tomcat 实例下的 lib 目录下。接着修改 tomcat 实例下 conf/contex.xml 文件</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WatchedResource</span><span class="token punctuation">&gt;</span></span>WEB-INF/web.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>WatchedResource</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- tomcat-redis-session共享配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.orangefunction.tomcat.redissessions.RedisSessionManager<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>192.168.1.149<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>6379<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">maxInactiveInterval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>60<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果 Redis 配置了访问权限，请添加密码:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WatchedResource</span><span class="token punctuation">&gt;</span></span>WEB-INF/web.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>WatchedResource</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- tomcat-redis-session共享配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.orangefunction.tomcat.redissessions.RedisSessionManager<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>192.168.1.149<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>6379<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>redispassword<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">maxInactiveInterval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>60<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="jwt-使用"><a href="#jwt-使用" class="header-anchor">#</a> JWT 使用</h4> <p>引入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>封装工具类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;renren.jwt&quot;</span><span class="token punctuation">)</span>

<span class="token annotation punctuation">@Component</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtils</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> expire<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> header<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 生成jwt token
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Date</span> nowDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//过期时间</span>
        <span class="token class-name">Date</span> expireDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>nowDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expire <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setHeaderParam</span><span class="token punctuation">(</span><span class="token string">&quot;typ&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>userId<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>nowDate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expireDate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS512<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    *获取载荷信息
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">Claims</span> <span class="token function">getClaimByToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;validate is token error &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * token是否过期
    * @return  true：过期
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isTokenExpired</span><span class="token punctuation">(</span><span class="token class-name">Date</span> expiration<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> expiration<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//getter、setter</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>生成 token</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> token <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>校验 token</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Claims</span> claims <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">getClaimByToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>；
<span class="token keyword">if</span><span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> jwtUtils<span class="token punctuation">.</span><span class="token function">isTokenExpired</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;token失效&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> userId <span class="token operator">=</span>   <span class="token class-name">Long</span><span class="token punctuation">.</span>parseLong（claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <div class="content edit-link"><a href="http://elb-791125809.cn-northwest-1.elb.amazonaws.com.cn:5335/edit/master/docs/doc-backend/framework/session.md" target="_blank" rel="noopener noreferrer">
      编辑此页面
    </a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="content page-nav"><p class="inner"><span class="prev"><a href="/doc-backend/framework/nginx-start.html" class="prev">&lt; nginx 简介</a></span> <span class="next"><a href="/doc-backend/framework/oauth2.html">
          OAuth2 简介
          &gt;
        </a></span></p></div> <div class="footer">数据中心 研发二部</div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.16cdc938.js" defer></script><script src="/assets/js/3.4f14b16d.js" defer></script><script src="/assets/js/1.02cf7ae9.js" defer></script><script src="/assets/js/43.8e4bef73.js" defer></script>
  </body>
</html>
